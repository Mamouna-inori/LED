<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>単語・一問一答クイズ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+JP:wght@400;500;700&display=swap" rel="stylesheet">
    <!-- PDF生成ライブラリ -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
    <style>
        :root {
            --bg-primary: #f1f5f9; /* slate-100 */
            --bg-secondary: #ffffff; /* white */
            --bg-tertiary: #e2e8f0; /* slate-200 */
            --text-primary: #0f172a; /* slate-900 */
            --text-secondary: #64748b; /* slate-500 */
            --border-color: #cbd5e1; /* slate-300 */
            --card-bg: #ffffff;
            --input-bg: #f8fafc; /* slate-50 */
            --input-border: #cbd5e1; /* slate-300 */
        }
        .dark {
            --bg-primary: #0f172a; /* slate-900 */
            --bg-secondary: #1e293b; /* slate-800 */
            --bg-tertiary: #0f172a; /* slate-900 */
            --text-primary: #f8fafc; /* slate-50 */
            --text-secondary: #94a3b8; /* slate-400 */
            --border-color: #334155; /* slate-700 */
            --card-bg: #1e293b;
            --input-bg: #334155; /* slate-700 */
            --input-border: #475569; /* slate-600 */
        }
        body {
            font-family: 'Inter', 'Noto Sans JP', sans-serif;
            background-color: var(--bg-primary);
            color: var(--text-primary);
            transition: background-color 0.3s, color 0.3s;
        }
        .card {
            background-color: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 0.75rem;
            padding: 2rem;
            box-shadow: 0 20px 25px -5px rgb(0 0 0 / 0.1), 0 8px 10px -6px rgb(0 0 0 / 0.1);
            transition: all 0.3s ease-in-out;
        }
        .hidden { display: none; }
        .btn {
            display: inline-block;
            font-weight: 600;
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            transition: all 0.2s ease-in-out;
            cursor: pointer;
            text-align: center;
        }
        .btn-primary { background-color: #4f46e5; color: white; }
        .btn-primary:hover { background-color: #4338ca; }
        .btn-secondary { background-color: #475569; color: white; }
        .btn-secondary:hover { background-color: #64748b; }
        .results-list-item {
            display: flex;
            justify-content: space-between;
            padding: 0.5rem 0;
            border-bottom: 1px solid var(--border-color);
        }
        .results-list-item:last-child { border-bottom: none; }
        .modal {
            position: fixed; inset: 0; background-color: rgba(0, 0, 0, 0.75);
            display: flex; align-items: center; justify-content: center;
            padding: 1rem; z-index: 50;
        }
        #user-input {
            background-color: var(--input-bg);
            border-color: var(--input-border);
            color: var(--text-primary);
        }
        #question-text-container {
             background-color: var(--bg-tertiary);
        }
        .theme-switch-wrapper {
            display: flex;
            align-items: center;
            position: fixed;
            top: 1rem;
            right: 1rem;
            z-index: 100;
        }
        .theme-switch {
            display: inline-block;
            height: 24px;
            position: relative;
            width: 48px;
        }
        .theme-switch input {
            display:none;
        }
        .slider {
            background-color: #475569;
            bottom: 0;
            cursor: pointer;
            left: 0;
            position: absolute;
            right: 0;
            top: 0;
            transition: .4s;
        }
        .slider:before {
            background-color: #fff;
            bottom: 4px;
            content: "";
            height: 16px;
            left: 4px;
            position: absolute;
            transition: .4s;
            width: 16px;
        }
        input:checked + .slider {
            background-color: #4f46e5;
        }
        input:checked + .slider:before {
            transform: translateX(24px);
        }
        .slider.round {
            border-radius: 34px;
        }
        .slider.round:before {
            border-radius: 50%;
        }
        /* List Screen Specific Styles */
        .status-badge {
            font-size: 0.7rem;
            padding: 0.1rem 0.4rem;
            border-radius: 9999px;
            color: white;
            white-space: nowrap;
        }
        .status-unattempted { background-color: #94a3b8; } /* slate-400 */
        .status-unlearned { background-color: #ef4444; } /* red-500 */
        .status-checking { background-color: #f59e0b; } /* amber-500 */
        .status-mastered { background-color: #22c55e; } /* green-500 */
        
        .answer-hidden {
            background-color: var(--text-secondary);
            color: var(--text-secondary);
            border-radius: 4px;
            cursor: pointer;
            user-select: none;
        }
        .answer-hidden:hover {
            opacity: 0.8;
        }
        .answer-reveal {
            background-color: transparent !important;
            color: var(--text-primary) !important;
        }
    </style>
</head>
<body class="flex items-center justify-center min-h-screen p-4">

    <div class="theme-switch-wrapper">
      <label class="theme-switch" for="checkbox">
        <input type="checkbox" id="checkbox" />
        <div class="slider round"></div>
      </label>
    </div>

    <div class="w-full max-w-xl h-[90vh] flex flex-col">
        <!-- Main App Container -->
        <div id="app-container" class="card flex flex-col h-full overflow-hidden relative">
            <!-- Mode Selection Screen -->
            <div id="mode-selection-screen" class="overflow-y-auto">
                <h1 class="text-3xl font-bold text-center mb-2">クイズ選択</h1>
                <p class="text-center text-secondary mb-8">挑戦するクイズを選んでください。</p>
                <div class="grid grid-cols-1 gap-4">
                    <button data-mode="public" class="mode-select-btn btn btn-primary w-full">公共テスト</button>
                    <button data-mode="english" class="mode-select-btn btn btn-primary w-full">英単語クイズ</button>
                    <button data-mode="kobun" class="mode-select-btn btn btn-primary w-full">古文単語クイズ</button>
                </div>
            </div>

            <!-- Start Screen (Template) -->
            <div id="start-screen-template" class="hidden flex flex-col h-full overflow-y-auto">
                 <h1 class="start-title text-3xl font-bold text-center mb-2"></h1>
                <p class="text-center text-secondary mb-6">学習状況を確認してクイズを始めよう！</p>
                <div class="mastery-stats grid grid-cols-2 sm:grid-cols-4 gap-4 text-center mb-8"></div>
                <div class="flex flex-col sm:flex-row gap-4 mb-4">
                    <button class="start-quiz-btn btn btn-primary w-full" data-length-type="10">ランダム10問</button>
                    <button class="start-quiz-btn btn btn-primary w-full" data-length-type="all">全範囲から出題</button>
                </div>
                <button class="view-list-btn btn btn-secondary w-full mb-4 !bg-indigo-600 hover:!bg-indigo-500 text-white">問題一覧を確認</button>
                <button class="reset-history-btn btn btn-secondary w-full !bg-red-800 hover:!bg-red-700">学習履歴をリセット</button>
                <button class="back-to-mode-selection btn btn-secondary w-full mt-4">モード選択に戻る</button>
                <div class="reset-feedback text-center text-green-400 mt-4 text-sm h-5"></div>
            </div>

            <!-- List Screen -->
            <div id="list-screen" class="hidden flex flex-col h-full">
                <div class="mb-4 flex-shrink-0">
                    <h2 class="text-xl font-bold mb-2"><span id="list-mode-title"></span> 一覧</h2>
                    <div class="flex gap-2 mb-2">
                        <input type="text" id="list-search" placeholder="検索..." class="flex-1 border rounded px-3 py-2 text-slate-800">
                        <label class="flex items-center space-x-2 cursor-pointer bg-slate-100 dark:bg-slate-700 border border-border-color px-3 py-2 rounded select-none min-w-fit">
                            <input type="checkbox" id="hide-answers-check" class="form-checkbox h-4 w-4 text-indigo-600">
                            <span class="text-sm">解答を隠す</span>
                        </label>
                    </div>
                </div>
                <div id="list-content" class="flex-1 overflow-y-auto space-y-2 pr-1 pb-4">
                    <!-- List items will be injected here -->
                </div>
                <button id="back-from-list-btn" class="btn btn-secondary w-full mt-2 flex-shrink-0">戻る</button>
            </div>


            <!-- Quiz Screen -->
            <div id="quiz-screen" class="hidden overflow-y-auto">
                <div class="flex justify-between items-center mb-6">
                    <h2 id="quiz-title" class="text-xl font-bold">クイズ</h2>
                    <p id="question-counter" class="text-secondary font-medium"></p>
                </div>
                <div id="question-text-container" class="p-6 rounded-lg mb-6 min-h-[100px] flex items-center justify-center">
                    <p id="question-text" class="text-2xl md:text-3xl font-bold text-center"></p>
                </div>
                <div class="space-y-4">
                    <input type="text" id="user-input" placeholder="解答を入力..." class="w-full border rounded-md px-4 py-3 focus:outline-none focus:ring-2 focus:ring-indigo-500" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false">
                    <button id="check-btn" class="btn btn-primary w-full">解答をチェック</button>
                    <button id="next-btn" class="btn btn-secondary w-full hidden">次の問題へ</button>
                </div>
                <div id="feedback" class="mt-6 text-center min-h-[4rem]"></div>
            </div>

            <!-- Result Screen -->
            <div id="result-screen" class="hidden text-center overflow-y-auto">
                <h2 class="text-2xl font-bold mb-4">結果発表</h2>
                <p class="text-5xl font-bold mb-2" id="score-text"></p>
                <p class="text-secondary mb-6" id="score-message"></p>
                <div id="mastery-results-extra">
                    <div class="bg-secondary rounded-lg p-4 mb-6 border border-border-color">
                        <p class="text-lg" id="mastery-count"></p>
                    </div>
                </div>
                <div id="results-details" class="text-left mb-6 max-h-60 overflow-y-auto">
                    <h3 class="font-bold text-lg mb-2">出題一覧</h3>
                    <div id="results-list" class="space-y-2"></div>
                </div>
                <button id="play-again-btn" class="btn btn-primary w-full">もう一度挑戦する</button>
                <div id="download-buttons" class="mt-4 flex flex-col sm:flex-row space-y-2 sm:space-y-0 sm:space-x-4">
                    <button id="download-csv-btn" class="btn btn-secondary w-full">未習得リストをCSVで保存</button>
                    <button id="download-pdf-btn" class="btn btn-secondary w-full">未習得リストをPDFで保存</button>
                </div>
                 <button class="back-to-mode-selection btn btn-secondary w-full mt-4">モード選択に戻る</button>
            </div>
        </div>
        <footer class="text-center mt-4 text-xs text-secondary flex-shrink-0">
            <p>学習を頑張りましょう！</p>
        </footer>
    </div>
    
    <!-- Modals -->
    <div id="confirm-modal" class="hidden modal">
        <div class="card p-6 max-w-sm w-full text-center shadow-xl">
            <p id="confirm-message" class="mb-6"></p>
            <div class="flex justify-center space-x-4">
                <button id="confirm-cancel-btn" class="btn btn-secondary w-1/2">キャンセル</button>
                <button id="confirm-ok-btn" class="btn w-1/2 !bg-red-800 hover:!bg-red-700">OK</button>
            </div>
        </div>
    </div>
    <div id="alert-modal" class="hidden modal">
        <div class="card p-6 max-w-sm w-full text-center shadow-xl">
            <p id="alert-message" class="mb-6"></p>
            <div class="flex justify-center">
                <button id="alert-ok-btn" class="btn btn-primary w-1/2">OK</button>
            </div>
        </div>
    </div>

    <script>
        // --- DATA ---
        // データセット
        const DATA_SETS = {
            public: [
                { id: 23101, question: "職業体験のため、学生が企業で一定期間無報酬で働くことを何というか", answers: ["インターンシップ"] },
                { id: 23102, question: "仕事と私生活の調和を何というか", answers: ["ワーク・ライフ・バランス"] },
                { id: 23103, question: "農業、林業、水産業など、自然にはたらきかける産業を何というか", answers: ["第一次産業"] },
                { id: 23104, question: "商業、金融、情報サービスなどの産業を何というか", answers: ["第三次産業"] },
                { id: 23105, question: "自動学習機能を持つ人工知能を何というか", answers: ["AI"] },
                { id: 23106, question: "革新的なアイデアや技術で新しい事業を展開する企業を何というか", answers: ["ベンチャー企業"] },
                { id: 23201, question: "正社員として入社し、同じ会社で定年まで勤務する雇用制度を何というか。", answers: ["終身雇用制"] },
                { id: 23202, question: "まず人を雇い、社内で経験を積ませ、適正な部署へ割りあてていく雇用システムを何というか", answers: ["メンバーシップ型"] },
                { id: 23203, question: "特定の仕事に対して、適正な能力を持った人を雇い割りあてていく雇用システムを何というか", answers: ["ジョブ型"] },
                { id: 23204, question: "勤務年数に応じて給料が上がっていく仕組みを何というか", answers: ["年功序列型賃金"] },
                { id: 23205, question: "職種や業種ごとではなく、会社ごとに組織される労働組合を何というか", answers: ["企業別労働組合"] },
                { id: 23206, question: "バブル崩壊後の長期不況があった1991年から2011年ごろを指す言葉は何か", answers: ["失われた20年"] },
                { id: 23207, question: "仕事の成果を評価基準にする考え方を何というか", answers: ["成果主義"] },
                { id: 23208, question: "パート、契約社員、派遣社員など、正社員以外の雇用形態を何というか", answers: ["非正規社員"] },
                { id: 23209, question: "2008 年に起こったアメリカ大手証券会社の倒産による世界的な経済危機は何か", answers: ["リーマン・ショック"] },
                { id: 23210, question: "同じ労働に対して雇用形態や性別を問わず同じ賃金を支払うことを何というか", answers: ["同一労働同一賃金"] },
                { id: 23211, question: "就労者１人あたり、就業１時間あたりの経済的成果の指標を何というか", answers: ["労働生産性"] },
                { id: 23212, question: "男女雇用機会均等法改正で企業に防止措置が義務付けられた性的言動を何というか", answers: ["セクシュアル・ハラスメント"] },
                { id: 23213, question: "時間外労働の規制、有休消化の義務化など、2019 年に行われたさまざま労働法改正を通称何というか", answers: ["働き方改革"] },
                { id: 23214, question: "外国人労働者増加のきっかけとなった 2019 年に改正された法律は何か", answers: ["出入国管理法"] },
                { id: 23215, question: "労働三権とは、団結権、団体交渉権と何か", answers: ["団体行動権"] },
                { id: 23216, question: "雇用者への異議申し立てのために労働者が結成できる組織は何か", answers: ["労働組合"] },
                { id: 23217, question: "労働三法とは、労働基準法、労働組合法と何か", answers: ["労働関係調整法"] },
                { id: 23218, question: "会社が労働基準法を順守するよう監督する機関は何か", answers: ["労働基準監督署"] },
                { id: 23219, question: "労使紛争を解決する機関には、労働委員会のほかに何が設置されているか", answers: ["労働局"] },
                { id: 23220, question: "職務の公益性の高さなどから労働基本権に制限がある職種は何か", answers: ["公務員"] },
                { id: 23301, question: "財政の３つの役割とは、資源配分、所得の再分配と何か", answers: ["景気の安定"] },
                { id: 23302, question: "所得が増えるほど納める税率も上がっていく仕組みを何というか", answers: ["累進課税"] },
                { id: 23303, question: "所得の再分配により自動的に景気が調整される仕組みを何というか", answers: ["自動安定化装置", "ビルト・イン・スタビライザー"] },
                { id: 23304, question: "景気を意図的に調整する政策を何というか", answers: ["裁量的財政政策", "フィスカル・ポリシー"] },
                { id: 23305, question: "政府の財政政策と日本銀行が行う金融政策を連動させることを何というか", answers: ["ポリシー・ミックス"] },
                { id: 23306, question: "日本政策金融公庫などの特殊法人などへあてられる予算を何というか", answers: ["政府関係機関予算"] },
                { id: 23307, question: "政府が債券を発行し金融機関から資金調達して行う融資を何というか", answers: ["財政投融資"] },
                { id: 23308, question: "災害時など緊急的に支出が必要な時に組む予算を何というか", answers: ["補正予算"] },
                { id: 23309, question: "所得税など直接納税者が納める租税を何というか", answers: ["直接税"] },
                { id: 23310, question: "消費税など納税する者と負担する者が異なる租税を何というか", answers: ["間接税"] },
                { id: 23311, question: "2019 年の消費税増税時に導入された、生活必需品など特定品目の課税率を低く設定する仕組みを何というか", answers: ["軽減税率"] },
                { id: 23312, question: "地方自治体に納める租税を何というか", answers: ["地方税"] },
                { id: 23313, question: "職種や働き方に関わらず等しく課税することで公平を図る考え方を何というか", answers: ["水平的公平"] },
                { id: 23314, question: "所得税のように収入に応じて税率を上げ公平を図る考え方を何というか", answers: ["垂直的公平"] },
                { id: 23315, question: "消費税は高所得者ほど税負担割合が低く、低所得者ほど負担割合は高くなる。この現象を何というか", answers: ["逆進性"] },
                { id: 23316, question: "会社が給料から所得税を引いて国に納税する仕組みを何というか", answers: ["源泉徴収"] },
                { id: 23317, question: "国債のうち、公共事業にあてられるものを何というか", answers: ["建設国債"] },
                { id: 23318, question: "国の経済規模を図る指標として、国内の生産物の価格から原材料費などを引いた付加価値の額を何というか", answers: ["GDP", "国内総生産"] },
                { id: 23319, question: "税収だけで歳出をまかなう財政収支を何というか", answers: ["基礎的財政収支", "プライマリー・バランス"] },
                { id: 23320, question: "公共事業（施設）の所有権はもち、運営権だけを民間委譲する仕組みを何というか", answers: ["コンセッション方式"] },
                { id: 23321, question: "０から１で表される国ごとの所得格差を表す指標を何というか", answers: ["ジニ係数"] },
                { id: 23401, question: "世界初の社会保障制度といわれる、1601 年に制定されたイギリスの法律は何か", answers: ["エリザベス救貧法"] },
                { id: 23402, question: "労災や年金などの社会保険法を制定したドイツ帝国の宰相は誰か", answers: ["ビスマルク"] },
                { id: 23403, question: "「ゆりかごから墓場まで」のフレーズで有名なイギリスの報告書は何か", answers: ["ベヴァリッジ報告"] },
                { id: 23404, question: "日本の社会保障の４つの柱は、社会保険、公的扶助、公衆衛生と何か", answers: ["社会福祉"] },
                { id: 23405, question: "生活困窮者へ生活費を給付する制度を何というか", answers: ["生活保護"] },
                { id: 23406, question: "2000 年から実施された高齢者や障がい者のための保険制度は何か", answers: ["介護保険"] },
                { id: 23407, question: "給与に比例した保険料を企業と折半で支払う年金を何というか", answers: ["厚生年金"] },
                { id: 23408, question: "退職世代の年金を同時代の現役世代の保険料でまかなう年金方式を何というか", answers: ["賦課方式"] },
                { id: 23409, question: "平均寿命や物価に合わせて年金の給付水準を調整する仕組みを何というか", answers: ["マクロ経済スライド"] },
                { id: 23410, question: "加入者本人が資金運用する年金を何というか", answers: ["確定拠出年金"] },
                { id: 23411, question: "医療費の一部自己負担を 75 歳以上の高齢者にも求める制度を何というか", answers: ["後期高齢者医療制度"] },
                { id: 23501, question: "需要量と供給量が一致する取り引き成立価格を何というか", answers: ["均衡価格"] },
                { id: 23502, question: "アダム・スミスは、市場経済では利己的に利益を追求しても、富が分配され社会全体の利益が増大していく過程を何と表現したか", answers: ["見えざる手"] },
                { id: 23503, question: "世界的な巨大 IT 企業４社を頭文字から何と総称するか", answers: ["GAFA"] },
                { id: 23504, question: "複数の同業企業が価格や生産量で協定を結んで市場を調整することを何というか", answers: ["カルテル"] },
                { id: 23505, question: "親会社が複数の子会社の株をもち支配することを何というか", answers: ["コンツェルン"] },
                { id: 23506, question: "公正な経済活動を保つために設置されている機関は何か", answers: ["公正取引委員会"] },
                { id: 23507, question: "「経済の憲法」といわれる、公正な市場経済を保つための法律は何か", answers: ["独占禁止法"] },
                { id: 23508, question: "寡占市場において、他社の価格目安になる優位企業を何というか", answers: ["プライスリーダー", "価格先導者"] },
                { id: 23509, question: "企業間の価格競争がなく、価格が下がらないことを何というか", answers: ["価格の下方硬直性"] },
                { id: 23510, question: "経済活動が間接的に引き起こすプラスの効果を何というか", answers: ["外部経済"] },
                { id: 23601, question: "銀行などが資金を集め、預金を個人や企業に貸し出す金融を何というか", answers: ["間接金融"] },
                { id: 23602, question: "株式などを発行し、企業が直接出資者から資金を集める金融を何というか", answers: ["直接金融"] },
                { id: 23603, question: "株式市場、債券市場を総称して何というか", answers: ["証券市場"] },
                { id: 23604, question: "銀行間での資金の融通のうち、短期で資金の貸し借りを行う場を何というか", answers: ["コール市場"] },
                { id: 23605, question: "担保不要で融資翌日に返済する資金取引を何というか", answers: ["無担保コール翌日物"] },
                { id: 23606, question: "銀行の預金通貨が企業などに貸し出された後、また銀行に預けられる中で、最初の預金の何倍もの貸出を行うことができる仕組みを何というか", answers: ["信用創造"] },
                { id: 23607, question: "社会全体の通貨の総量を何というか", answers: ["マネーストック"] },
                { id: 23608, question: "国家や中央銀行が発行する法定通貨ではなくデジタルデータ上のみで流通する通貨を何というか", answers: ["暗号資産", "仮想通貨"] },
                { id: 23609, question: "ネット銀行や電子マネーのように金融と IT を結びつけたサービスを何というか", answers: ["フィンテック"] },
                { id: 23610, question: "適正な会計情報の開示のため、企業が資産や負債の状況を示したものを何というか", answers: ["貸借対照表", "バランスシート"] },
                { id: 23611, question: "日銀の役割には、「銀行の銀行」「政府の銀行」と、もう１つ何があるか", answers: ["円紙幣の発行", "日本銀行券の発行"] },
                { id: 23612, question: "発行する紙幣を保有する金の量と結び付ける制度を何というか", answers: ["金本位制"] },
                { id: 23613, question: "金の保有量と無関係に通貨の流通量を調整する制度を何というか", answers: ["管理通貨制度"] },
                { id: 23614, question: "不況時に行う、通貨の供給量を増やして金利を下げる政策を何というか", answers: ["金融緩和"] },
                { id: 23615, question: "好況時に行う、供給量を減らし金利を上げる政策を何というか", answers: ["金融引き締め"] },
                { id: 23616, question: "預金準備金の割合を操作して通貨量を調整する政策を何というか", answers: ["預金準備率操作"] },
                { id: 23617, question: "日銀が民間金融機関に貸し出す金利を操作する政策を何というか", answers: ["公定歩合操作"] },
                { id: 23618, question: "物価が継続して下落していく現象を何というか", answers: ["デフレ", "デフレーション"] },
                { id: 23619, question: "1999 年に導入した無担保コールレートを０%に誘導する政策は何か", answers: ["ゼロ金利政策"] },
                { id: 23620, question: "銀行が日銀に預けた預金に対して手数料を取ることを何というか", answers: ["マイナス金利"] },
                { id: 23621, question: "日銀が目標としている物価上昇率は何％か", answers: ["2"] },
                { id: 23622, question: "日銀が投資信託などを積極的に買う金融政策を何というか", answers: ["量的・質的金融緩和"] },
                { id: 23623, question: "戦後行われていた、政府が金融機関を保護する政策を何というか", answers: ["護送船団方式"] },
                { id: 23624, question: "1996 年から始まった日本の金融システム改革を何というか", answers: ["金融ビッグバン"] },
                { id: 23625, question: "金融機関が破綻した場合、元本 1000 万円までとその利息を補償する仕組みを何というか", answers: ["ペイオフ"] },
                { id: 23626, question: "投資家から集めた資金を専門家が運用し、収益を投資家へ還元する金融商品を何というか", answers: ["投資信託"] },
                { id: 23627, question: "環境、社会、企業統治に配慮した企業に投資することを何というか", answers: ["ESG投資"] },
                { id: 23701, question: "企業が国外で事業展開するため、国外工場などに直接投資することを何というか", answers: ["対外直接投資"] },
                { id: 23702, question: "日本、アメリカ、イギリス、フランス、ドイツ、イタリア、カナダの先進国７ヵ国の首脳が集まる会議を何と呼ぶか", answers: ["サミット", "G7"] },
                { id: 23703, question: "新興国の中でも経済発展が著しい国５ヵ国を頭文字から何と呼ぶか", answers: ["BRICS"] },
                { id: 23704, question: "先進国、EU、経済発展著しい新興国の首脳が集まる金融サミットを通称何というか", answers: ["G20"] },
                { id: 23705, question: "欧州理事会常任議長（EU 大統領）が設置された 2009 年の条約は何か", answers: ["リスボン条約"] },
                { id: 23706, question: "2016 年の国民投票で可決され、2020 年に EU から離脱した国はどこか", answers: ["イギリス"] },
                { id: 23707, question: "東南アジア諸国連合をアルファベット５文字で何というか", answers: ["ASEAN"] },
                { id: 23708, question: "北米域内の関税撤廃などを目的とした同盟をアルファベット５文字で何というか", answers: ["USMCA"] },
                { id: 23709, question: "日本を含む太平洋地域 12 ヵ国の経済連携協定をアルファベット３文字で何というか", answers: ["TPP"] },
                { id: 23710, question: "自国の産業を守るため、関税などを引き上げる貿易を何というか", answers: ["保護貿易"] },
                { id: 23711, question: "18 世紀の経済学者リカードが唱えた、それぞれの国が得意な産業に特化し貿易を行った方が全体の生産量が増加するという考え方を何というか", answers: ["比較生産費説"] },
                { id: 23712, question: "農産物や鉱産物などの一次産品に依存する経済を何というか", answers: ["モノカルチャー経済"] },
                { id: 23713, question: "発展途上国の中でも、資源もなく工業化が進まない国々を何というか", answers: ["後発発展途上国", "LDC"] },
                { id: 23714, question: "発展途上国間での格差のことを何というか", answers: ["南南問題"] },
                { id: 23715, question: "平均寿命や識字率などから算出される国ごとの格差を表す指標を何というか", answers: ["人間開発指標", "HDI"] },
                { id: 23716, question: "発展途上国の経済開発や支援を目的に 1964 年に設立された国連の常設機関は何か", answers: ["UNCTAD", "国連貿易開発会議"] },
                { id: 23717, question: "日本を含む先進国 38 ヵ国が加盟する経済機構をアルファベット４文字で何というか", answers: ["OECD"] },
                { id: 23718, question: "政府開発援助のことをアルファベット３文字で何というか", answers: ["ODA"] },
                { id: 23719, question: "資源産出国が、先進国との間での交易条件の改善を求めた宣言は何か", answers: ["新国際秩序樹立宣言", "NIEO樹立宣言"] },
                { id: 23720, question: "発展途上国の製品を適正価格で取り引きする仕組みを何というか", answers: ["フェアトレード"] },
                { id: 23721, question: "多様な民族の文化や伝統を多様性として認め合い共存する社会を何と表現するか", answers: ["多文化主義", "マルチカルチュラリズム"] }
            ],
            english: [
                { id: 1, question: "混乱", answers: ["confusion"] },
                { id: 2, question: "言語学者", answers: ["linguist"] },
                { id: 3, question: "～を要約する", answers: ["sum up"] },
                { id: 4, question: "原理", answers: ["principle"] },
                { id: 5, question: "基準", answers: ["norm", "basis"] },
                { id: 6, question: "規範", answers: ["norm"] },
                { id: 7, question: "適切な", answers: ["proper"] },
                { id: 8, question: "乗り物", answers: ["vehicle"] },
                { id: 9, question: "車", answers: ["vehicle"] },
                { id: 10, question: "壊れる", answers: ["break"] },
                { id: 11, question: "故障する", answers: ["break down"] },
                { id: 12, question: "様態", answers: ["manner"] },
                { id: 13, question: "方法", answers: ["manner"] },
                { id: 14, question: "作法", answers: ["manner"] },
                { id: 15, question: "陳述", answers: ["statement"] },
                { id: 16, question: "主張", answers: ["statement", "case"] },
                { id: 17, question: "言葉", answers: ["statement"] },
                { id: 18, question: "曲げる", answers: ["bend"] },
                { id: 19, question: "少し", answers: ["slightly"] },
                { id: 20, question: "わずかに", answers: ["slightly", "grain"] },
                { id: 21, question: "受け入れ", answers: ["acceptance"] },
                { id: 22, question: "承諾", answers: ["acceptance"] },
                { id: 23, question: "反映", answers: ["reflection"] },
                { id: 24, question: "現れ", answers: ["reflection"] },
                { id: 25, question: "影響", answers: ["reflection", "impact"] },
                { id: 26, question: "意図", answers: ["intention"] },
                { id: 27, question: "意思", answers: ["intention"] },
                { id: 28, question: "返答", answers: ["response"] },
                { id: 29, question: "なめらかに", answers: ["smoothly"] },
                { id: 30, question: "円滑に", answers: ["smoothly"] },
                { id: 31, question: "言葉のやりとり", answers: ["interaction"] },
                { id: 32, question: "触れあい", answers: ["interaction"] },
                { id: 33, question: "よく考えること", answers: ["consideration"] },
                { id: 34, question: "考慮すべきこと", answers: ["consideration"] },
                { id: 35, question: "距離", answers: ["distance"] },
                { id: 36, question: "不安な", answers: ["uncomfortable"] },
                { id: 37, question: "不愉快な", answers: ["uncomfortable"] },
                { id: 38, question: "打ち解けた", answers: ["casual"] },
                { id: 39, question: "～を心に留めておく", answers: ["keep ～ in mind"] },
                { id: 40, question: "覚えている", answers: ["keep ～ in mind"] },
                { id: 41, question: "快適な", answers: ["comfortable"] },
                { id: 42, question: "居心地がよい", answers: ["comfortable"] },
                { id: 43, question: "明白な", answers: ["evident"] },
                { id: 44, question: "すさまじい", answers: ["tremendous"] },
                { id: 45, question: "ものすごい", answers: ["tremendous"] },
                { id: 46, question: "最近の", answers: ["recent"] },
                { id: 47, question: "近ごろの", answers: ["recent"] },
                { id: 48, question: "原則", answers: ["basis"] },
                { id: 49, question: "～(電源)をつける", answers: ["turn on"] },
                { id: 50, question: "指示", answers: ["instruction"] },
                { id: 51, question: "命令", answers: ["instruction"] },
                { id: 52, question: "対比", answers: ["contrast"] },
                { id: 53, question: "対照", answers: ["contrast"] },
                { id: 54, question: "対照的に", answers: ["in contrast"] },
                { id: 55, question: "を利用する", answers: ["draw on"] },
                { id: 56, question: "～するときはいつでも", answers: ["whenever"] },
                { id: 57, question: "組織(化)", answers: ["organization"] },
                { id: 58, question: "団体", answers: ["organization"] },
                { id: 59, question: "準備", answers: ["preparation"] },
                { id: 60, question: "手配", answers: ["arrangement"] },
                { id: 61, question: "配置", answers: ["arrangement"] },
                { id: 62, question: "取り決め", answers: ["arrangement"] },
                { id: 63, question: "頭のよい", answers: ["smart"] },
                { id: 64, question: "洗練された", answers: ["smart"] },
                { id: 65, question: "(判断・行為などが)賢い", answers: ["wise"] },
                { id: 66, question: "作物", answers: ["crop"] },
                { id: 67, question: "収穫高", answers: ["crop"] },
                { id: 68, question: "収穫(物", answers: ["harvest"] },
                { id: 69, question: "期)", answers: ["harvest"] },
                { id: 70, question: "～を収穫する", answers: ["harvest"] },
                { id: 71, question: "穀物", answers: ["grain"] },
                { id: 72, question: "わずか", answers: ["grain"] },
                { id: 73, question: "小麦", answers: ["wheat"] },
                { id: 74, question: "～を提供する", answers: ["provide"] },
                { id: 75, question: "養う", answers: ["provide"] },
                { id: 76, question: "備える", answers: ["provide"] },
                { id: 77, question: "供給(量)", answers: ["supply"] },
                { id: 78, question: "必需品", answers: ["supply"] },
                { id: 79, question: "～を供給する", answers: ["supply"] },
                { id: 80, question: "装備", answers: ["equipment"] },
                { id: 81, question: "備品", answers: ["equipment"] },
                { id: 82, question: "重大な", answers: ["serious", "grave"] },
                { id: 83, question: "まじめな", answers: ["serious"] },
                { id: 84, question: "真剣な", answers: ["grave"] },
                { id: 85, question: "墓穴", answers: ["grave"] },
                { id: 86, question: "病気", answers: ["disease"] },
                { id: 87, question: "がん(癌)", answers: ["cancer"] },
                { id: 88, question: "政策", answers: ["policy"] },
                { id: 89, question: "信条", answers: ["policy"] },
                { id: 90, question: "年齢", answers: ["age"] },
                { id: 91, question: "年代", answers: ["age"] },
                { id: 92, question: "老年", answers: ["age"] },
                { id: 93, question: "時代", answers: ["age", "era"] },
                { id: 94, question: "年を取る", answers: ["age"] },
                { id: 95, question: "(政治・歴史上重要な)時代", answers: ["era"] },
                { id: 96, question: "食事", answers: ["diet"] },
                { id: 97, question: "ダイエット", answers: ["diet"] },
                { id: 98, question: "国会", answers: ["diet"] },
                { id: 99, question: "ダイエットをする", answers: ["diet"] },
                { id: 100, question: "議会", answers: ["parliament"] },
                { id: 101, question: "(英)国会", answers: ["parliament"] },
                { id: 102, question: "状態", answers: ["shape"] },
                { id: 103, question: "(体)形", answers: ["shape"] },
                { id: 104, question: "世界的な", answers: ["global", "worldwide"] },
                { id: 105, question: "全体的な", answers: ["global"] },
                { id: 106, question: "世界中で", answers: ["worldwide"] },
                { id: 107, question: "栄養", answers: ["nutrition"] },
                { id: 108, question: "タンパク質", answers: ["protein"] },
                { id: 109, question: "基本的な", answers: ["fundamental"] },
                { id: 110, question: "必須の", answers: ["fundamental"] },
                { id: 111, question: "根本的な", answers: ["radical"] },
                { id: 112, question: "急進的な", answers: ["radical"] },
                { id: 113, question: "利用権", answers: ["access"] },
                { id: 114, question: "接近", answers: ["access"] },
                { id: 115, question: "症例", answers: ["case"] },
                { id: 116, question: "実例", answers: ["case"] },
                { id: 117, question: "場合", answers: ["case"] },
                { id: 118, question: "事件", answers: ["case"] },
                { id: 119, question: "論拠", answers: ["case"] },
                { id: 120, question: "事実", answers: ["case"] },
                { id: 121, question: "箱", answers: ["case"] },
                { id: 122, question: "程度", answers: ["deal"] },
                { id: 123, question: "量", answers: ["deal"] },
                { id: 124, question: "取引", answers: ["deal"] },
                { id: 125, question: "扱う", answers: ["deal"] },
                { id: 126, question: "取引する", answers: ["deal"] },
                { id: 127, question: "交渉する", answers: ["negotiate"] },
                { id: 128, question: "～を交渉して取り決める", answers: ["negotiate"] },
                { id: 129, question: "うまく処理する", answers: ["cope"] },
                { id: 130, question: "～に耐える", answers: ["bear", "endure"] },
                { id: 131, question: "～を支える", answers: ["bear"] },
                { id: 132, question: "～を持つ", answers: ["bear"] },
                { id: 133, question: "～を産む", answers: ["bear"] },
                { id: 134, question: "妥協(する)", answers: ["compromise"] },
                { id: 135, question: "1つかみの量の～", answers: ["handful"] },
                { id: 136, question: "誰も～ない", answers: ["nobody"] },
                { id: 137, question: "無名の人", answers: ["nobody"] },
                { id: 138, question: "衝撃", answers: ["impact"] },
                { id: 139, question: "衝突", answers: ["impact"] },
                { id: 140, question: "鉄", answers: ["iron"] },
                { id: 141, question: "教訓", answers: ["lesson"] },
                { id: 142, question: "授業", answers: ["lesson"] },
                { id: 143, question: "講義", answers: ["lecture"] },
                { id: 144, question: "講演", answers: ["lecture"] },
                { id: 145, question: "講義(講演)する", answers: ["lecture"] },
                { id: 146, question: "(学生に課される)レポート", answers: ["essay"] },
                { id: 147, question: "エッセイ", answers: ["essay"] },
                { id: 148, question: "～を維持する", answers: ["preserve"] },
                { id: 149, question: "～を保存する", answers: ["preserve"] },
                { id: 150, question: "(資源)保護", answers: ["conservation"] },
                { id: 151, question: "一致して", answers: ["according"] },
                { id: 152, question: "したがって", answers: ["according"] },
                { id: 153, question: "委員会", answers: ["committee"] },
                { id: 154, question: "(全)委員", answers: ["committee"] },
                { id: 155, question: "平均", answers: ["average"] },
                { id: 156, question: "平均的な", answers: ["average"] },
                { id: 157, question: "最大限", answers: ["maximum"] },
                { id: 158, question: "最低限", answers: ["minimum"] },
                { id: 159, question: "日常(の)", answers: ["daily"] },
                { id: 160, question: "毎日(の)", answers: ["daily"] },
                { id: 161, question: "年1回の", answers: ["annual"] },
                { id: 162, question: "1年間の", answers: ["annual"] },
                { id: 163, question: "最後の", answers: ["last"] },
                { id: 164, question: "この前の", answers: ["last"] },
                { id: 165, question: "続く", answers: ["last"] },
                { id: 166, question: "長持ちする", answers: ["last"] },
                { id: 167, question: "いつまでも続く", answers: ["persist"] },
                { id: 168, question: "固執する", answers: ["persist"] },
                { id: 169, question: "一定の", answers: ["steady"] },
                { id: 170, question: "安定した", answers: ["steady", "stable"] },
                { id: 171, question: "減少", answers: ["decline"] },
                { id: 172, question: "衰退", answers: ["decline"] },
                { id: 173, question: "低下", answers: ["decline"] },
                { id: 174, question: "減少する", answers: ["decline"] },
                { id: 175, question: "衰退する", answers: ["decline"] },
                { id: 176, question: "断る", answers: ["decline"] },
                { id: 177, question: "選択肢", answers: ["option"] },
                { id: 178, question: "選択(権の自由)", answers: ["option"] },
                { id: 179, question: "～を採用する", answers: ["adopt"] },
                { id: 180, question: "～を養子にする", answers: ["adopt"] },
                { id: 181, question: "子供", answers: ["kid"] },
                { id: 182, question: "冗談を言う", answers: ["kid"] },
                { id: 183, question: "幼稚園", answers: ["kindergarten"] },
                { id: 184, question: "～を予定する", answers: ["schedule"] },
                { id: 185, question: "日課", answers: ["routine"] },
                { id: 186, question: "型通りの", answers: ["routine"] },
                { id: 187, question: "計画", answers: ["scheme"] },
                { id: 188, question: "悪巧み", answers: ["scheme"] },
                { id: 189, question: "10代の若者(通例、13～19歳)", answers: ["teenager"] },
                { id: 190, question: "まさに", answers: ["single"] },
                { id: 191, question: "ただ一つの", answers: ["single"] },
                { id: 192, question: "個々の", answers: ["single"] },
                { id: 193, question: "独身の", answers: ["single"] },
                { id: 194, question: "1人用の", answers: ["single"] },
                { id: 195, question: "唯一の", answers: ["sole"] },
                { id: 196, question: "単独の", answers: ["sole"] },
                { id: 197, question: "単なる", answers: ["mere"] },
                { id: 198, question: "ほんの", answers: ["mere"] },
                { id: 199, question: "要因", answers: ["factor"] },
                { id: 200, question: "因子", answers: ["factor"] },
                { id: 201, question: "要素", answers: ["element"] },
                { id: 202, question: "元素", answers: ["element"] },
                { id: 203, question: "基礎", answers: ["element"] },
                { id: 204, question: "自然の力", answers: ["element"] },
                { id: 205, question: "～を予言(予測)する", answers: ["predict"] },
                { id: 206, question: "～を予報する", answers: ["forecast"] },
                { id: 207, question: "～を予想する", answers: ["forecast"] },
                { id: 208, question: "予報(予想)", answers: ["forecast"] },
                { id: 209, question: "学業(成績)", answers: ["achievement"] },
                { id: 210, question: "業績", answers: ["achievement"] },
                { id: 211, question: "達成", answers: ["achievement"] },
                { id: 212, question: "～を成し遂げる", answers: ["accomplish", "attain"] },
                { id: 213, question: "～に達する", answers: ["attain"] },
                { id: 214, question: "得点", answers: ["score"] },
                { id: 215, question: "楽譜", answers: ["score"] },
                { id: 216, question: "得点する", answers: ["score"] },
                { id: 217, question: "大いに", answers: ["far"] },
                { id: 218, question: "遠くへ", answers: ["far"] },
                { id: 219, question: "遠い", answers: ["far"] }
            ],
            kobun: [
                { question: "優美だ。風流だ。上品だ。(やー)", answer: "やさし", kanji: "" },
                { question: "けなげだ。殊勝だ。感心だ。", answer: "やさし", kanji: "" },
                { question: "すぐれている。すばらしい。", answer: "いうなり", kanji: "" },
                { question: "優美だ。風流だ。上品だ。(いー)", answer: "いうなり", kanji: "" },
                { question: "優美だ。優雅だ。しっとりと上品だ。", answer: "なまめかし", kanji: "" },
                { question: "風流だ。物好きだ。", answer: "すきずきし", kanji: "" },
                { question: "色好みだ。浮気だ。好色だ。", answer: "すきずきし", kanji: "" },
                { question: "風情がある。由緒ありげだ。", answer: "ゆゑゆゑし", kanji: "" },
                { question: "《ふるまいなどが》物慣れている。洗練されている。", answer: "らうらうじ", kanji: "" },
                { question: "《容姿などが》気品がある。上品だ。", answer: "らうらうじ", kanji: "" },
                { question: "風情を解する。分別がある。思いやりがある。", answer: "こころあり", kanji: "" },
                { question: "詩歌管弦の遊び。狩り。行楽。", answer: "あそび", kanji: "" },
                { question: "口ずさむ。朗詠する。言葉を口に出して言う。", answer: "うちいづ", kanji: "" },
                { question: "筆跡。字。", answer: "て", kanji: "" },
                { question: "曲。演奏法。", answer: "て", kanji: "" },
                { question: "幼い。あどけない。幼稚だ。", answer: "いはけなし", kanji: "" },
                { question: "道理に合わない。無理だ。", answer: "わりなし", kanji: "" },
                { question: "耐えがたい。つらい。", answer: "わりなし", kanji: "" },
                { question: "どうしようもない。やむをえない。", answer: "わりなし", kanji: "" },
                { question: "並々でない。はなはだしい。", answer: "わりなし", kanji: "" },
                { question: "大げさだ。仰々しい。ひどい。", answer: "おどろおどろし", kanji: "" },
                { question: "不気味だ。騒々しい。", answer: "おどろおどろし", kanji: "" },
                { question: "平気だ。平然としている。素知らぬふりをしている。", answer: "つれなし", kanji: "" },
                { question: "冷淡だ。薄情だ。", answer: "つれなし", kanji: "" },
                { question: "何の変化もない。もとのままだ。", answer: "つれなし", kanji: "" },
                { question: "整っている。きちんとしている。端正だ。", answer: "うるはし", kanji: "" },
                { question: "正式だ。折り目正しい。", answer: "うるはし", kanji: "" },
                { question: "大人らしい。大人びている。", answer: "おとなし", kanji: "" },
                { question: "思慮分別がある。中心的な立場にある。", answer: "おとなし", kanji: "" },
                { question: "場所が狭い。(物が)たくさんある。", answer: "ところせし", kanji: "" },
                { question: "窮屈だ。気づまりだ。", answer: "ところせし", kanji: "" },
                { question: "堂々としている。仰々しい。", answer: "ところせし", kanji: "" },
                { question: "薄情だ。冷淡だ。思いやりがない。", answer: "つらし", kanji: "" },
                { question: "うらめしい。たえられない。つらい。", answer: "つらし", kanji: "" },
                { question: "気が引ける。気恥ずかしい。", answer: "つつまし", kanji: "" },
                { question: "恐ろしい", answer: "かしこし", kanji: "" },
                { question: "おそれ多い。もったいない。尊い。", answer: "かしこし", kanji: "" },
                { question: "すぐれている。利口だ。", answer: "かしこし", kanji: "" },
                { question: "はなはだしく。", answer: "かしこし", kanji: "" },
                { question: "もの足りない。心さみしい。つまらない。", answer: "さうざうし", kanji: "" },
                { question: "ふさわしい。似つかわしい。似合う。", answer: "つきづきし", kanji: "" },
                { question: "もっともらしい。", answer: "つきづきし", kanji: "" },
                { question: "ふさわしくない。似つかわしくない。似合わない。", answer: "つきなし", kanji: "" },
                { question: "不愉快だ。目障りだ。気に食わない。", answer: "ものし", kanji: "" },
                { question: "無礼だ。不作法だ。", answer: "なめし", kanji: "" },
                { question: "すばらしい。立派だ。", answer: "めでたし", kanji: "" },
                { question: "かわいそうだ。気の毒だ。", answer: "いとほし", kanji: "" },
                { question: "かわいい。いとしい。", answer: "いとほし", kanji: "" },
                { question: "ものさびしい。恐ろしい。寒々としている。", answer: "すごし", kanji: "" },
                { question: "気に食わない。しゃくにさわる。", answer: "めざまし", kanji: "" },
                { question: "意外と素晴らしい。思いがけず立派だ。", answer: "めざまし", kanji: "" },
                { question: "不快だ。うっとうしい。", answer: "むつかし", kanji: "" },
                { question: "わずらわしい。やっかいだ。面倒だ。", answer: "むつかし", kanji: "" },
                { question: "気味悪い。", answer: "むつかし", kanji: "" }
            ]
        };

        // --- App State ---
        let allData = {};
        let quizItems = [];
        let currentQuizMode = null;
        let currentStartScreen = null;
        let currentQuestionIndex = 0;
        let score = 0;
        let masteryStatus = {};
        let masteredBeforeQuiz = 0;
        let onConfirmAction = null;

        // --- DOM Elements ---
        const appContainer = document.getElementById('app-container');
        const modeSelectionScreen = document.getElementById('mode-selection-screen');
        const startScreenTemplate = document.getElementById('start-screen-template');
        const quizScreen = document.getElementById('quiz-screen');
        const resultScreen = document.getElementById('result-screen');
        const listScreen = document.getElementById('list-screen');
        
        const quizTitle = document.getElementById('quiz-title');
        const questionCounter = document.getElementById('question-counter');
        const questionText = document.getElementById('question-text');
        const userInput = document.getElementById('user-input');
        const checkBtn = document.getElementById('check-btn');
        const nextBtn = document.getElementById('next-btn');
        const feedback = document.getElementById('feedback');
        const scoreText = document.getElementById('score-text');
        const scoreMessage = document.getElementById('score-message');
        const masteryCount = document.getElementById('mastery-count');
        const resultsList = document.getElementById('results-list');
        const downloadCsvBtn = document.getElementById('download-csv-btn');
        const downloadPdfBtn = document.getElementById('download-pdf-btn');
        const playAgainBtn = document.getElementById('play-again-btn');
        const confirmModal = document.getElementById('confirm-modal');
        const confirmMessage = document.getElementById('confirm-message');
        const confirmOkBtn = document.getElementById('confirm-ok-btn');
        const confirmCancelBtn = document.getElementById('confirm-cancel-btn');
        const alertModal = document.getElementById('alert-modal');
        const alertMessage = document.getElementById('alert-message');
        const alertOkBtn = document.getElementById('alert-ok-btn');
        const themeToggle = document.getElementById('checkbox');
        
        // List Screen Elements
        const listModeTitle = document.getElementById('list-mode-title');
        const listSearch = document.getElementById('list-search');
        const listContent = document.getElementById('list-content');
        const hideAnswersCheck = document.getElementById('hide-answers-check');
        const backFromListBtn = document.getElementById('back-from-list-btn');

        // --- LocalStorage Functions ---
        const getLocalStorage = (key) => {
            try {
                const data = localStorage.getItem(key);
                return data ? JSON.parse(data) : {};
            } catch (e) {
                console.error("ローカルストレージの読み込みに失敗:", e);
                return {};
            }
        };
        const setLocalStorage = (key, value) => {
            try {
                localStorage.setItem(key, JSON.stringify(value));
            } catch (e) {
                console.error("ローカルストレージへの保存に失敗:", e);
            }
        };

        // --- Helper Functions ---
        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }

        function normalizeAnswer(str, mode) {
            if (typeof str !== 'string') return '';
            let normalized = str.trim()
                .replace(/[Ａ-Ｚａ-ｚ０-９．＝－（）『』]/g, s => String.fromCharCode(s.charCodeAt(0) - 0xFEE0))
                .replace(/　/g, ' ')
                .replace(/[〜～]/g, '-') 
                .replace(/＝/g, '=');

            if (mode !== 'english') {
                normalized = normalized.replace(/ /g, '');
            } else {
                normalized = normalized.toLowerCase();
            }

            return normalized;
        }

        // --- Modal ---
        function showAlertModal(message) {
            alertMessage.textContent = message;
            alertModal.classList.remove('hidden');
        }
        function hideAlertModal() { alertModal.classList.add('hidden'); }
        function showConfirmModal(message, onConfirm) {
            confirmMessage.textContent = message;
            onConfirmAction = onConfirm;
            confirmModal.classList.remove('hidden');
        }
        function hideConfirmModal() {
            confirmModal.classList.add('hidden');
            onConfirmAction = null;
        }

        // --- Screen Management ---
        function showScreen(screen) {
            const screens = document.querySelectorAll('#app-container > div');
            screens.forEach(s => s.classList.add('hidden'));
            screen.classList.remove('hidden');
            currentStartScreen = (screen.id.includes('-start-screen')) ? screen : currentStartScreen;
        }
        
        // --- Mastery and Stats Logic ---
        function createStartScreen(mode, title) {
            const screen = startScreenTemplate.cloneNode(true);
            screen.id = `${mode}-start-screen`;
            screen.querySelector('.start-title').textContent = title;
            screen.querySelector('.mastery-stats').id = `${mode}-mastery-stats`;
            screen.querySelector('.start-quiz-btn[data-length-type="10"]').dataset.mode = mode;
            screen.querySelector('.start-quiz-btn[data-length-type="all"]').dataset.mode = mode;
            screen.querySelector('.view-list-btn').dataset.mode = mode; // Set mode for list btn
            screen.querySelector('.reset-history-btn').dataset.mode = mode;
            screen.querySelector('.reset-feedback').id = `reset-${mode}-feedback`;
            
            // Insert before list-screen (keep list screen at end or appropriate place)
            appContainer.insertBefore(screen, listScreen);
        }

        function updateMasteryStats(mode) {
            const data = allData[mode];
            const statusData = masteryStatus[mode];
            const container = document.getElementById(`${mode}-mastery-stats`);
            if (!container) return;
            
            container.innerHTML = `
                <div><p class="text-2xl font-bold text-sky-400" id="${mode}-unattempted-count">0</p><p class="text-xs text-secondary">未実施</p></div>
                <div><p class="text-2xl font-bold text-red-400" id="${mode}-unlearned-count">0</p><p class="text-xs text-secondary">未習得</p></div>
                <div><p class="text-2xl font-bold text-amber-400" id="${mode}-checking-count">0</p><p class="text-xs text-secondary">点検中</p></div>
                <div><p class="text-2xl font-bold text-green-400" id="${mode}-mastered-count">0</p><p class="text-xs text-secondary">習得</p></div>
            `;
            const counts = { '未実施': 0, '未習得': 0, '点検中': 0, '習得': 0 };
            data.forEach(item => {
                const status = statusData[item.id] || '未実施';
                counts[status]++;
            });
            document.getElementById(`${mode}-unattempted-count`).textContent = counts['未実施'];
            document.getElementById(`${mode}-unlearned-count`).textContent = counts['未習得'];
            document.getElementById(`${mode}-checking-count`).textContent = counts['点検中'];
            document.getElementById(`${mode}-mastered-count`).textContent = counts['習得'];
        }

        function resetHistory(mode) {
            const modeTitleMap = { english: '英単語', public: '公共', kobun: '古文単語' };
            const modeTitle = modeTitleMap[mode] || 'クイズ';
            const message = `${modeTitle}の学習履歴をすべてリセットしますか？`;
            showConfirmModal(message, () => {
                masteryStatus[mode] = {};
                setLocalStorage(`${mode}MasteryStatus`, {});
                updateMasteryStats(mode);
                const feedbackEl = document.getElementById(`reset-${mode}-feedback`);
                feedbackEl.textContent = '履歴をリセットしました。';
                setTimeout(() => { feedbackEl.textContent = ''; }, 2000);
            });
        }
        
        // --- List Screen Logic ---
        function showListScreen(mode) {
            currentQuizMode = mode;
            const titleMap = { english: '英単語クイズ', public: '公共テスト', kobun: '古文単語クイズ' };
            listModeTitle.textContent = titleMap[mode];
            listSearch.value = ''; // Reset search
            hideAnswersCheck.checked = false; // Reset toggle
            
            renderListContent(mode);
            showScreen(listScreen);
        }
        
        function renderListContent(mode, filterText = '') {
            const data = allData[mode];
            const statusData = masteryStatus[mode];
            
            listContent.innerHTML = '';
            
            // Filter data
            const filteredData = data.filter(item => {
                if (!filterText) return true;
                const lowerFilter = filterText.toLowerCase();
                const questionMatch = item.question.toLowerCase().includes(lowerFilter);
                let answerMatch = false;
                if (mode === 'public' || mode === 'english') {
                    answerMatch = item.answers.some(a => a.toLowerCase().includes(lowerFilter));
                } else {
                    answerMatch = item.answer.toLowerCase().includes(lowerFilter);
                }
                const kanjiMatch = item.kanji && item.kanji.includes(filterText);
                return questionMatch || answerMatch || kanjiMatch;
            });

            if (filteredData.length === 0) {
                listContent.innerHTML = '<p class="text-center text-secondary py-4">該当する問題がありません。</p>';
                return;
            }

            const isHideAnswers = hideAnswersCheck.checked;

            filteredData.forEach(item => {
                const status = statusData[item.id] || '未実施';
                let statusClass = 'status-unattempted';
                if (status === '未習得') statusClass = 'status-unlearned';
                if (status === '点検中') statusClass = 'status-checking';
                if (status === '習得') statusClass = 'status-mastered';
                
                let answerDisplay = '';
                if (mode === 'public' || mode === 'english') {
                    answerDisplay = item.answers.join(' / ');
                } else {
                    answerDisplay = item.answer;
                    if (item.kanji) answerDisplay += ` <span class="text-xs text-secondary">(${item.kanji})</span>`;
                }

                const itemDiv = document.createElement('div');
                itemDiv.className = 'bg-secondary border border-border-color rounded p-3 flex flex-col gap-1';
                
                // Question Row
                const questionRow = document.createElement('div');
                questionRow.className = 'flex justify-between items-start gap-2';
                questionRow.innerHTML = `
                    <div class="flex-1 font-medium text-sm sm:text-base">${item.question}</div>
                    <span class="status-badge ${statusClass} flex-shrink-0">${status}</span>
                `;
                itemDiv.appendChild(questionRow);
                
                // Answer Row
                const answerRow = document.createElement('div');
                answerRow.className = `text-sm mt-1 p-2 ${isHideAnswers ? 'answer-hidden' : 'text-indigo-600 font-bold'}`;
                answerRow.innerHTML = isHideAnswers ? 'タップして解答を表示' : answerDisplay;
                
                if (isHideAnswers) {
                    answerRow.onclick = function() {
                        if (this.classList.contains('answer-hidden')) {
                            this.classList.remove('answer-hidden');
                            this.classList.add('answer-reveal');
                            this.innerHTML = answerDisplay;
                        }
                    };
                }
                
                itemDiv.appendChild(answerRow);
                listContent.appendChild(itemDiv);
            });
        }
        
        // List Screen Event Listeners
        listSearch.addEventListener('input', (e) => {
            renderListContent(currentQuizMode, e.target.value);
        });
        
        hideAnswersCheck.addEventListener('change', () => {
             renderListContent(currentQuizMode, listSearch.value);
        });
        
        backFromListBtn.addEventListener('click', () => {
             showScreen(document.getElementById(`${currentQuizMode}-start-screen`));
        });

        // --- Core Quiz Logic ---
        function startQuiz(mode, lengthType) {
            currentQuizMode = mode;
            score = 0;
            currentQuestionIndex = 0;
            
            const data = allData[mode];
            const statusData = masteryStatus[mode];
            masteredBeforeQuiz = Object.values(statusData).filter(s => s === '習得').length;

            const unattempted = data.filter(item => !statusData[item.id] || statusData[item.id] === '未実施');
            const unlearned = data.filter(item => statusData[item.id] === '未習得');
            const checking = data.filter(item => statusData[item.id] === '点検中');
            const mastered = data.filter(item => statusData[item.id] === '習得');

            let pool = [...shuffleArray(unattempted), ...shuffleArray(unlearned)];
            
            if (lengthType === 'all') {
                pool.push(...shuffleArray(checking));
                quizItems = shuffleArray(pool);
            } else { // '10'
                if (pool.length < 10) pool.push(...shuffleArray(checking));
                if (pool.length < 10) pool.push(...shuffleArray(mastered));
                quizItems = shuffleArray(pool).slice(0, Math.min(10, data.length));
            }
            
            if (quizItems.length === 0) {
                 showAlertModal("出題できる問題がありません！");
                 return;
            }

            showScreen(quizScreen);
            displayQuestion();
        }

        function displayQuestion() {
            if (currentQuestionIndex >= quizItems.length) {
                showResults();
                return;
            }
            const currentItem = quizItems[currentQuestionIndex];
            const modeTitleMap = { english: '英単語クイズ', public: '公共テスト', kobun: '古文単語クイズ' };
            quizTitle.textContent = modeTitleMap[currentQuizMode];
            questionCounter.textContent = `問題 ${currentQuestionIndex + 1} / ${quizItems.length}`;
            questionText.textContent = currentItem.question;
            
            userInput.value = '';
            userInput.disabled = false;
            userInput.focus();
            feedback.innerHTML = '';
            checkBtn.classList.remove('hidden');
            nextBtn.classList.add('hidden');
        }

        function checkAnswer() {
            const userAnswer = userInput.value.trim();
            const currentItem = quizItems[currentQuestionIndex];
            userInput.disabled = true;

            let isCorrect = false;
            let correctAnswersText = '';
            const statusData = masteryStatus[currentQuizMode];
            const storageKey = `${currentQuizMode}MasteryStatus`;

            if (currentQuizMode === 'kobun') {
                correctAnswersText = currentItem.answer;
                isCorrect = normalizeAnswer(userAnswer, currentQuizMode) === normalizeAnswer(correctAnswersText, currentQuizMode);
            } else { // public & english (Array answers)
                correctAnswersText = currentItem.answers.join(' / ');
                const normalizedUserAnswer = normalizeAnswer(userAnswer, currentQuizMode);
                isCorrect = currentItem.answers.some(ans => normalizeAnswer(ans, currentQuizMode) === normalizedUserAnswer);
            }
            
            const itemId = currentItem.id;
            const currentStatus = statusData[itemId] || '未実施';
            let feedbackHtml = '';

            if (isCorrect && userAnswer.length > 0) {
                score++;
                feedbackHtml = `<p class="text-green-400 font-bold text-lg">正解！</p>`;
                if (currentStatus === '未実施' || currentStatus === '未習得') statusData[itemId] = '点検中';
                else if (currentStatus === '点検中') statusData[itemId] = '習得';
            } else {
                feedbackHtml = `<p class="text-red-400 font-bold text-lg">不正解...</p><p class="text-secondary">正解は: <span class="font-bold text-primary">${correctAnswersText}</span></p>`;
                statusData[itemId] = '未習得';
            }
            
            if (currentQuizMode === 'kobun' && currentItem.kanji) {
                feedbackHtml += `<p class="text-sky-400 mt-1">【漢字】 ${currentItem.kanji}</p>`;
            }
            feedback.innerHTML = feedbackHtml;

            setLocalStorage(storageKey, statusData);
            
            checkBtn.classList.add('hidden');
            nextBtn.classList.remove('hidden');
            nextBtn.focus();
        }
        
        function showResults() {
            showScreen(resultScreen);
            scoreText.textContent = `${score} / ${quizItems.length}`;
            let message = '';
            if (score === quizItems.length) message = '素晴らしい！全問正解です！';
            else if (score >= quizItems.length * 0.7) message = '良い調子ですね！';
            else if (score >= quizItems.length * 0.4) message = 'もう少し！頑張りましょう。';
            else message = '次はもっと頑張ろう！';
            scoreMessage.textContent = message;

            resultsList.innerHTML = '';
            quizItems.forEach(item => {
                const listItem = document.createElement('div');
                listItem.className = 'results-list-item';
                const question = item.question;
                const answer = (currentQuizMode === 'public' || currentQuizMode === 'english') ? item.answers.join(' / ') : item.answer;
                listItem.innerHTML = `
                    <span class="text-secondary w-2/3 truncate">${question}</span>
                    <span class="font-bold w-1/3 text-right">${answer}</span>`;
                resultsList.appendChild(listItem);
            });
            
            const data = allData[currentQuizMode];
            const statusData = masteryStatus[currentQuizMode];
            
            const learnedCount = Object.values(statusData).filter(s => s === '習得').length;
            const change = learnedCount - masteredBeforeQuiz;
            const changeString = change > 0 ? `+${change}` : (change < 0 ? `${change}` : `${change}`);
            masteryCount.innerHTML = `現在の習得数: <span class="font-bold text-xl">${learnedCount}</span> / ${data.length} <span class="text-sm">(前回比: ${changeString})</span>`;
        }

        // --- Initialization and Event Listeners ---
        function initializeAllData() {
            // Process English (Simple array)
            allData.english = DATA_SETS.english.map((item, index) => ({ ...item, id: index })); // id is already set but map ensures index consistency

            // Process Public Affairs
            allData.public = DATA_SETS.public.map(q => ({...q}));
            
            // Process Kobun
            allData.kobun = DATA_SETS.kobun.map((item, index) => ({ ...item, id: index }));
            
            // Load mastery from localStorage for all modes
            Object.keys(DATA_SETS).forEach(mode => {
                const data = allData[mode];
                const savedStatus = getLocalStorage(`${mode}MasteryStatus`) || {};
                const validIds = new Set(data.map(item => item.id));
                Object.keys(savedStatus).forEach(id => {
                    if (!validIds.has(parseInt(id, 10))) delete savedStatus[id];
                });
                masteryStatus[mode] = savedStatus;
                setLocalStorage(`${mode}MasteryStatus`, savedStatus);
            });
        }
        
        function downloadUnlearnedCSV() {
            const data = allData[currentQuizMode];
            const statusData = masteryStatus[currentQuizMode];

            const unlearnedItems = data.filter(item => statusData[item.id] === '未習得');
            if (unlearnedItems.length === 0) { showAlertModal("未習得の項目はありません。"); return; }
            
            let headers, body;
            switch(currentQuizMode) {
                case 'english':
                    headers = "日本語,English\r\n";
                    body = unlearnedItems.map(item => `"${item.question}","${item.answers.join(' / ')}"`).join('\r\n');
                    break;
                case 'kobun':
                    headers = "問題,答え,漢字\r\n";
                    body = unlearnedItems.map(item => `"${item.question}","${item.answer}","${item.kanji || ''}"`).join('\r\n');
                    break;
                case 'public':
                    headers = "問題,解答\r\n";
                    body = unlearnedItems.map(item => `"${item.question}","${item.answers.join(' / ')}"`).join('\r\n');
                    break;
            }
            let csvContent = "data:text/csv;charset=utf-8,\uFEFF" + headers + body;

            const link = document.createElement("a");
            link.setAttribute("href", encodeURI(csvContent));
            link.setAttribute("download", `unlearned_${currentQuizMode}.csv`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        async function downloadUnlearnedPDF() {
            const data = allData[currentQuizMode];
            const statusData = masteryStatus[currentQuizMode];
            
            const unlearnedItems = data.filter(item => statusData[item.id] === '未習得');
            if (unlearnedItems.length === 0) { showAlertModal("未習得の項目はありません。"); return; }

            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            try {
                showAlertModal("PDFを生成中です...");
                 doc.setFont("Helvetica"); 
                 let y = 15;
                 doc.text("Unlearned Items List", 14, y);
                 y += 10;
                 
                 unlearnedItems.forEach(item => {
                     if (y > 280) { doc.addPage(); y = 15; }
                     let textLine = '';
                     switch(currentQuizMode) {
                        case 'english':
                            textLine = `${item.question}: ${item.answers.join(' / ')}`;
                            break;
                        case 'kobun':
                            textLine = `${item.question}: ${item.answer} [${item.kanji || ''}]`;
                            break;
                        default:
                            textLine = `${item.question}: ${item.answers.join(' / ')}`;
                            break;
                     }
                     const splitText = doc.splitTextToSize(textLine, 180);
                     doc.text(splitText, 14, y);
                     y += (splitText.length * 7);
                 });
                doc.save(`unlearned_${currentQuizMode}.pdf`);
            } catch (e) {
                console.error("PDF生成エラー:", e);
                showAlertModal("PDFの生成に失敗しました。");
            } finally {
                hideAlertModal();
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            initializeAllData();
            
            const titleMap = { english: '英単語クイズ', public: '公共テスト', kobun: '古文単語クイズ' };
            Object.keys(DATA_SETS).forEach(mode => createStartScreen(mode, titleMap[mode]));

            document.body.addEventListener('click', (e) => {
                const target = e.target;
                if (target.matches('.mode-select-btn')) {
                    const mode = target.dataset.mode;
                    updateMasteryStats(mode);
                    showScreen(document.getElementById(`${mode}-start-screen`));
                } else if (target.matches('.start-quiz-btn')) {
                    const mode = target.dataset.mode;
                    const lengthType = target.dataset.lengthType;
                    startQuiz(mode, lengthType);
                } else if (target.matches('.view-list-btn')) { // View List Button Click
                    const mode = target.dataset.mode;
                    showListScreen(mode);
                } else if (target.matches('.reset-history-btn')) {
                    const mode = target.dataset.mode;
                    resetHistory(mode);
                } else if (target.matches('.back-to-mode-selection')) {
                    showScreen(modeSelectionScreen);
                }
            });
            
            const currentTheme = localStorage.getItem('theme');
            if (currentTheme === 'dark') {
                document.documentElement.classList.add('dark');
                themeToggle.checked = true;
            }
            showScreen(modeSelectionScreen);
        });

        // Quiz Flow Listeners
        checkBtn.addEventListener('click', checkAnswer);
        nextBtn.addEventListener('click', () => { currentQuestionIndex++; displayQuestion(); });
        playAgainBtn.addEventListener('click', () => {
            updateMasteryStats(currentQuizMode);
            showScreen(currentStartScreen);
        });
        userInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
                e.preventDefault();
                if (!checkBtn.classList.contains('hidden')) checkBtn.click();
                else if (!nextBtn.classList.contains('hidden')) nextBtn.click();
            }
        });

        // Other Listeners
        downloadCsvBtn.addEventListener('click', downloadUnlearnedCSV);
        downloadPdfBtn.addEventListener('click', downloadUnlearnedPDF);
        confirmOkBtn.addEventListener('click', () => { if (onConfirmAction) { onConfirmAction(); hideConfirmModal(); } });
        confirmCancelBtn.addEventListener('click', hideConfirmModal);
        alertOkBtn.addEventListener('click', hideAlertModal);
        
        themeToggle.addEventListener('change', function() {
            if(this.checked) {
                document.documentElement.classList.add('dark');
                localStorage.setItem('theme', 'dark');
            } else {
                document.documentElement.classList.remove('dark');
                localStorage.setItem('theme', 'light');
            }
        });
        
    </script>
</body>
</html>
