<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>単語・一問一答クイズ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+JP:wght@400;500;700&display=swap" rel="stylesheet">
    <!-- PDF生成ライブラリ -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
    <style>
        :root {
            --bg-primary: #f1f5f9; /* slate-100 */
            --bg-secondary: #ffffff; /* white */
            --bg-tertiary: #e2e8f0; /* slate-200 */
            --text-primary: #0f172a; /* slate-900 */
            --text-secondary: #64748b; /* slate-500 */
            --border-color: #cbd5e1; /* slate-300 */
            --card-bg: #ffffff;
            --input-bg: #f8fafc; /* slate-50 */
            --input-border: #cbd5e1; /* slate-300 */
        }
        .dark {
            --bg-primary: #0f172a; /* slate-900 */
            --bg-secondary: #1e293b; /* slate-800 */
            --bg-tertiary: #0f172a; /* slate-900 */
            --text-primary: #f8fafc; /* slate-50 */
            --text-secondary: #94a3b8; /* slate-400 */
            --border-color: #334155; /* slate-700 */
            --card-bg: #1e293b;
            --input-bg: #334155; /* slate-700 */
            --input-border: #475569; /* slate-600 */
        }
        body {
            font-family: 'Inter', 'Noto Sans JP', sans-serif;
            background-color: var(--bg-primary);
            color: var(--text-primary);
            transition: background-color 0.3s, color 0.3s;
        }
        .card {
            background-color: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 0.75rem;
            padding: 2rem;
            box-shadow: 0 20px 25px -5px rgb(0 0 0 / 0.1), 0 8px 10px -6px rgb(0 0 0 / 0.1);
            transition: all 0.3s ease-in-out;
        }
        .hidden { display: none; }
        .btn {
            display: inline-block;
            font-weight: 600;
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            transition: all 0.2s ease-in-out;
            cursor: pointer;
            text-align: center;
        }
        .btn-primary { background-color: #4f46e5; color: white; }
        .btn-primary:hover { background-color: #4338ca; }
        .btn-secondary { background-color: #475569; color: white; }
        .btn-secondary:hover { background-color: #64748b; }
        .results-list-item {
            display: flex;
            justify-content: space-between;
            padding: 0.5rem 0;
            border-bottom: 1px solid var(--border-color);
        }
        .results-list-item:last-child { border-bottom: none; }
        .modal {
            position: fixed; inset: 0; background-color: rgba(0, 0, 0, 0.75);
            display: flex; align-items: center; justify-content: center;
            padding: 1rem; z-index: 50;
        }
        #user-input {
            background-color: var(--input-bg);
            border-color: var(--input-border);
            color: var(--text-primary);
        }
        #question-text-container {
             background-color: var(--bg-tertiary);
        }
        .theme-switch-wrapper {
            display: flex;
            align-items: center;
            position: fixed;
            top: 1rem;
            right: 1rem;
            z-index: 100;
        }
        .theme-switch {
            display: inline-block;
            height: 24px;
            position: relative;
            width: 48px;
        }
        .theme-switch input {
            display:none;
        }
        .slider {
            background-color: #475569;
            bottom: 0;
            cursor: pointer;
            left: 0;
            position: absolute;
            right: 0;
            top: 0;
            transition: .4s;
        }
        .slider:before {
            background-color: #fff;
            bottom: 4px;
            content: "";
            height: 16px;
            left: 4px;
            position: absolute;
            transition: .4s;
            width: 16px;
        }
        input:checked + .slider {
            background-color: #4f46e5;
        }
        input:checked + .slider:before {
            transform: translateX(24px);
        }
        .slider.round {
            border-radius: 34px;
        }
        .slider.round:before {
            border-radius: 50%;
        }
    </style>
</head>
<body class="flex items-center justify-center min-h-screen p-4">

    <div class="theme-switch-wrapper">
      <label class="theme-switch" for="checkbox">
        <input type="checkbox" id="checkbox" />
        <div class="slider round"></div>
      </label>
    </div>

    <div class="w-full max-w-xl">
        <!-- Main App Container -->
        <div id="app-container" class="card">
            <!-- Mode Selection Screen -->
            <div id="mode-selection-screen">
                <h1 class="text-3xl font-bold text-center mb-2">クイズ選択</h1>
                <p class="text-center text-secondary mb-8">挑戦するクイズを選んでください。</p>
                <div class="grid grid-cols-1 gap-4">
                    <button data-mode="public" class="mode-select-btn btn btn-primary w-full">公共テスト</button>
                    <button data-mode="english" class="mode-select-btn btn btn-primary w-full">英単語クイズ</button>
                    <button data-mode="kobun" class="mode-select-btn btn btn-primary w-full">古文単語クイズ</button>
                </div>
            </div>

            <!-- Start Screen (Template) -->
            <div id="start-screen-template" class="hidden">
                 <h1 class="start-title text-3xl font-bold text-center mb-2"></h1>
                <p class="text-center text-secondary mb-6">学習状況を確認してクイズを始めよう！</p>
                <div class="mastery-stats grid grid-cols-2 sm:grid-cols-4 gap-4 text-center mb-8"></div>
                <div class="flex flex-col sm:flex-row gap-4 mb-4">
                    <button class="start-quiz-btn btn btn-primary w-full" data-length-type="10">ランダム10問</button>
                    <button class="start-quiz-btn btn btn-primary w-full" data-length-type="all">全範囲から出題</button>
                </div>
                <button class="reset-history-btn btn btn-secondary w-full !bg-red-800 hover:!bg-red-700">学習履歴をリセット</button>
                <button class="back-to-mode-selection btn btn-secondary w-full mt-4">モード選択に戻る</button>
                <div class="reset-feedback text-center text-green-400 mt-4 text-sm h-5"></div>
            </div>


            <!-- Quiz Screen -->
            <div id="quiz-screen" class="hidden">
                <div class="flex justify-between items-center mb-6">
                    <h2 id="quiz-title" class="text-xl font-bold">クイズ</h2>
                    <p id="question-counter" class="text-secondary font-medium"></p>
                </div>
                <div id="question-text-container" class="p-6 rounded-lg mb-6 min-h-[100px] flex items-center justify-center">
                    <p id="question-text" class="text-2xl md:text-3xl font-bold text-center"></p>
                </div>
                <div class="space-y-4">
                    <input type="text" id="user-input" placeholder="解答を入力..." class="w-full border rounded-md px-4 py-3 focus:outline-none focus:ring-2 focus:ring-indigo-500" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false">
                    <button id="check-btn" class="btn btn-primary w-full">解答をチェック</button>
                    <button id="next-btn" class="btn btn-secondary w-full hidden">次の問題へ</button>
                </div>
                <div id="feedback" class="mt-6 text-center min-h-[4rem]"></div>
            </div>

            <!-- Result Screen -->
            <div id="result-screen" class="hidden text-center">
                <h2 class="text-2xl font-bold mb-4">結果発表</h2>
                <p class="text-5xl font-bold mb-2" id="score-text"></p>
                <p class="text-secondary mb-6" id="score-message"></p>
                <div id="mastery-results-extra">
                    <div class="bg-secondary rounded-lg p-4 mb-6 border border-border-color">
                        <p class="text-lg" id="mastery-count"></p>
                    </div>
                </div>
                <div id="results-details" class="text-left mb-6 max-h-60 overflow-y-auto">
                    <h3 class="font-bold text-lg mb-2">出題一覧</h3>
                    <div id="results-list" class="space-y-2"></div>
                </div>
                <button id="play-again-btn" class="btn btn-primary w-full">もう一度挑戦する</button>
                <div id="download-buttons" class="mt-4 flex flex-col sm:flex-row space-y-2 sm:space-y-0 sm:space-x-4">
                    <button id="download-csv-btn" class="btn btn-secondary w-full">未習得リストをCSVで保存</button>
                    <button id="download-pdf-btn" class="btn btn-secondary w-full">未習得リストをPDFで保存</button>
                </div>
                 <button class="back-to-mode-selection btn btn-secondary w-full mt-4">モード選択に戻る</button>
            </div>
        </div>
        <footer class="text-center mt-4 text-xs text-secondary">
            <p>学習を頑張りましょう！</p>
        </footer>
    </div>
    
    <!-- Modals -->
    <div id="confirm-modal" class="hidden modal">
        <div class="card p-6 max-w-sm w-full text-center shadow-xl">
            <p id="confirm-message" class="mb-6"></p>
            <div class="flex justify-center space-x-4">
                <button id="confirm-cancel-btn" class="btn btn-secondary w-1/2">キャンセル</button>
                <button id="confirm-ok-btn" class="btn w-1/2 !bg-red-800 hover:!bg-red-700">OK</button>
            </div>
        </div>
    </div>
    <div id="alert-modal" class="hidden modal">
        <div class="card p-6 max-w-sm w-full text-center shadow-xl">
            <p id="alert-message" class="mb-6"></p>
            <div class="flex justify-center">
                <button id="alert-ok-btn" class="btn btn-primary w-1/2">OK</button>
            </div>
        </div>
    </div>

    <script>
        // --- DATA ---
        // 新しいデータセット
        const DATA_SETS = {
            public: [
                { id: 21301, question: "裁判所は国会や内閣の干渉を受けないという原則を何というか", answers: ["司法権の独立"] },
                { id: 21302, question: "法律が憲法に違反していることを何というか", answers: ["違憲"] },
                { id: 21303, question: "国会に設置され裁判官を罷免することができる裁判所は何か", answers: ["弾劾裁判所"] },
                { id: 21304, question: "私人間の争いを解決する裁判を何というか", answers: ["民事裁判"] },
                { id: 21305, question: "検察官と被告人が対峙し刑罰を争う裁判を何というか", answers: ["刑事裁判"] },
                { id: 21306, question: "日本では3回まで裁判を受けられる。この制度を何というか", answers: ["三審制"] },
                { id: 21307, question: "一審判決に不服を申し立て、二審に再審理を求めることを何というか", answers: ["控訴"] },
                { id: 21308, question: "最高裁判所に再審理を求めることを何というか", answers: ["上告"] },
                { id: 21309, question: "判決確定後でも裁判のやり直しを行うことができる制度は何か", answers: ["再審制度"] },
                { id: 21310, question: "他人の犯罪を告発すると告発者の処分が軽減される制度を何というか", answers: ["司法取引"] },
                { id: 21311, question: "法律が違憲と判断された場合、何が行われるか", answers: ["法改正"] },
                { id: 21312, question: "最高裁判所長官の指名を行う機関はどこか", answers: ["内閣"] },
                { id: 21313, question: "自費で弁護士を雇えない場合、国費で弁護人を付することができる制度を何というか", answers: ["国選弁護制度"] },
                { id: 21314, question: "最高裁判所の裁判官が適任かどうか判断するための国民の投票を何というか", answers: ["国民審査"] },
                { id: 21315, question: "裁判員の対象年齢は何歳以上か", answers: ["18歳"] },
                { id: 21316, question: "裁判員制度の対象となるのは何審か", answers: ["一審"] },
                { id: 21317, question: "裁判員制度では有罪・無罪のほかに何を決めるか", answers: ["量刑"] },
                { id: 21318, question: "刑罰は犯罪に対する報いであるという考え方を何というか", answers: ["応報刑論"] },
                { id: 21319, question: "刑罰は犯罪の予防のためにあるという考え方を何というか", answers: ["目的刑論"] },
                { id: 21320, question: "犯罪被害者や遺族が裁判で被告人尋問や証人尋問ができる制度は何か", answers: ["被害者参加制度"] },
                { id: 21321, question: "不起訴となった事件について、判断が妥当か否かを審査する制度は何か", answers: ["検察審査会制度"] },
                { id: 21322, question: "14歳以上、20歳未満の者が犯した犯罪を裁く法律を何というか", answers: ["少年法"] },
                { id: 21323, question: "事後に制定された法律によって罰せられないことを何というか", answers: ["遡及処罰の禁止"] },
                { id: 21324, question: "被告人は判決が確定しない限り無罪として扱うという原則を何というか", answers: ["無罪推定の法則"] },
                { id: 21325, question: "無罪の者が刑罰を科されることを何というか", answers: ["冤罪"] },
                { id: 21326, question: "逮捕には裁判官が発する逮捕状を必要とする刑事手続きの仕組みを何というか", answers: ["令状主義"] },
                { id: 21327, question: "取り調べなどで言いたくないことを言わない権利を何というか", answers: ["黙秘権"] },
                { id: 22101, question: "民主主義の起源とされる国はどこか", answers: ["ギリシャ"] },
                { id: 22102, question: "市民が直接政治に参加し合意を形成していく政治システムを何というか", answers: ["直接民主主義"] },
                { id: 22103, question: "市民が代表者を選び、代表者に政治を委ねるシステムを何というか", answers: ["間接民主主義", "議会制民主主義"] },
                { id: 22104, question: "国民が直接投票により罷免できる裁判官は誰か", answers: ["最高裁判所裁判官"] },
                { id: 22105, question: "選挙権が得られる年齢はいくつか", answers: ["18歳"] },
                { id: 22106, question: "誰に投票したか明かされない選挙の仕組みを何というか", answers: ["秘密投票"] },
                { id: 22107, question: "国籍をもつすべての成人が投票できる選挙を何というか", answers: ["普通選挙"] },
                { id: 22108, question: "1つの選挙区から1人の当選者を選出する選挙制度を何というか", answers: ["小選挙区制"] },
                { id: 22109, question: "政党を選んで投票する選挙制度を何というか", answers: ["比例代表制"] },
                { id: 22110, question: "選挙区の人口の偏りで議員数と有権者数の比率に差が出ることを何というか", answers: ["一票の格差"] },
                { id: 22111, question: "落選した候補者に投じられた票を何というか", answers: ["死票"] },
                { id: 22112, question: "選挙区で落選した候補者が比例区で復活当選の機会を与える制度を何というか", answers: ["重複立候補制"] },
                { id: 22113, question: "比例代表選挙であらかじめ当選順位を発表しておく仕組みを何というか", answers: ["拘束名簿式"] },
                { id: 22114, question: "公正な選挙のため、選挙運動の禁止事項などをまとめた法律は何か", answers: ["公職選挙法"] },
                { id: 22115, question: "選挙活動違反で候補者本人の行為でなくても当選無効になること何というか", answers: ["連座制"] },
                { id: 22116, question: "名簿の登録地以外でも投票できる制度を何というか", answers: ["不在者投票"] },
                { id: 22117, question: "投票日の前に投票できる制度を何というか", answers: ["期日前投票"] },
                { id: 22118, question: "衆議院議員、参議院議員の任期はそれぞれ何年か", answers: ["衆議院4年、参議院6年"] },
                { id: 22119, question: "衆議院議員、参議院議員の被選挙権はそれぞれ何歳か", answers: ["衆議院議員25歳、参議院議員30歳"] },
                { id: 22120, question: "条例や政策について国民に広く意見を求める制度を何というか", answers: ["パブリックコメント", "意見公募"] },
                { id: 22121, question: "政治を健全に機能させるための情報公開の制度は、国民の何の権利に基づくか", answers: ["知る権利"] },
                { id: 22122, question: "2022年1月現在、自由民主党と連立政権を組んでいる政党はどこか", answers: ["公明党"] },
                { id: 22123, question: "自由民主党政権が続いてきた戦後の政治状況を何というか", answers: ["55年体制"] },
                { id: 22124, question: "有力な政党2つが政権獲得を目指すこと何というか", answers: ["二大政党制"] },
                { id: 22125, question: "複数の政党で政権を担当することを何というか", answers: ["連立政権"] },
                { id: 22126, question: "プライバシーにかかわる情報の利用制限を義務付ける法律は何か", answers: ["個人情報保護法"] },
                { id: 22127, question: "政府が特定した機密情報を漏洩した公務員を処罰する法律は何か", answers: ["特定秘密保護法"] },
                { id: 22128, question: "新聞社やテレビ局が行う統計的社会調査を何というか", answers: ["世論調査"] },
                { id: 22129, question: "マスコミは世論への影響力が大きいことから何といわれているか", answers: ["第四の権力"] },
                { id: 22130, question: "特定の政党を支持しない人々の集団を何というか", answers: ["無党派層"] },
                { id: 22131, question: "大衆の意見に過度に迎合した政治を何というか", answers: ["ポピュリズム"] },
                { id: 22132, question: "メディアの情報を適切に判断し読み解く能力を何というか", answers: ["メディアリテラシー", "情報リテラシー"] },
                { id: 22133, question: "若年層の政治的無関心などの結果、起こっている問題は何か", answers: ["投票率の低下"] },
                { id: 22201, question: "国会は衆議院と参議院の2つから構成される。これを何というか", answers: ["二院制"] },
                { id: 22202, question: "両院の議決が一致しない場合、最終的にどちらの議決が優先されるか", answers: ["衆議院"] },
                { id: 22203, question: "予算、条約などで両院の議決が一致しないときに開かれる会議は何か", answers: ["両院協議会"] },
                { id: 22204, question: "法案について、識者の意見を聞くために国会で開かれるものは何か", answers: ["公聴会"] },
                { id: 22205, question: "国会議員が政府や官庁の行政に対して調査を行う権利を何というか", answers: ["国政調査権"] },
                { id: 22206, question: "国会議員が国会会期中に逮捕されない特権を何というか", answers: ["不逮捕特権"] },
                { id: 22207, question: "議員の言論活動を保障するため、院内での発言に責任を問われない特権を何というか", answers: ["免責特権"] },
                { id: 22208, question: "議員により発議された法案を何というか", answers: ["議員立法"] },
                { id: 22209, question: "毎年1月に召集され、予算案と法律案を審議する国会を何というか", answers: ["通常国会"] },
                { id: 22210, question: "補正予算案やもち越された議題を審議する国会を何というか", answers: ["臨時国会"] },
                { id: 22211, question: "国会が指名を行う大臣は誰か", answers: ["内閣総理大臣"] },
                { id: 22212, question: "衆議院が内閣に不信任決議した時、内閣が選択できることは総辞職と何か", answers: ["衆議院の解散"] },
                { id: 22213, question: "国会と内閣が密接に関係して政治を動かしていく仕組みを何というか", answers: ["議院内閣制"] },
                { id: 22214, question: "東日本大震災からの復興のため期限付きで設置された省庁は何か", answers: ["復興庁"] },
                { id: 22215, question: "2023年4月に設置された新しい庁は何か", answers: ["こども家庭庁"] },
                { id: 22216, question: "各省の幹部人事を内閣主導で決定するために置かれた局は何か", answers: ["内閣人事局"] },
                { id: 22217, question: "内閣総理大臣が主宰する、内閣の意思決定を行う会議は何か", answers: ["閣議"] },
                { id: 22218, question: "中央官庁の公務員が政治の中心的役割を果たしている状況を何というか", answers: ["官僚政治"] },
                { id: 22219, question: "政治を政治家が主導して行うために設置された役職は大臣政務官と何か", answers: ["副大臣"] },
                { id: 22220, question: "法律の細部の取り決めなどや命令を行政機関に委ねることを何というか", answers: ["委任立法"] },
                { id: 22221, question: "経済活動活性化のため、さまざまな規則や認可制度を緩めることを何というか", answers: ["規制緩和"] },
                { id: 22222, question: "官僚が民間企業や団体に幹部として再就職することを何というか", answers: ["天下り"] },
                { id: 22223, question: "2007年に民営化された公営事業は何か", answers: ["郵政事業"] },
                { id: 22224, question: "住民にとって必要な最低限度の生活環境を何というか", answers: ["シビルミニマム"] },
                { id: 22225, question: "地方自治体の財源を補うため国から支出されるお金は、地方交付税と何か", answers: ["国庫支出金"] },
                { id: 22226, question: "地方自治体の自主財源の割合が低い状況を何と表すか", answers: ["三割自治"] },
                { id: 22227, question: "自治体に寄付をする代わりに所得税などの控除を受けられる仕組みを何というか", answers: ["ふるさと納税"] },
                { id: 22228, question: "2000年に廃止されるまで地方自治体が国の代理で行っていた事務を何というか", answers: ["機関委任事務"] },
                { id: 22229, question: "地方の自立を目指し、2000年に施行された法律は何か", answers: ["地方分権一括法"] },
                { id: 22230, question: "地方への税源移譲、地方交付税の見直しなどを一本化して進めた改革を何というか", answers: ["三位一体の改革"] },
                { id: 22231, question: "税の優遇や金融支援などを特別に受けられる自治体を何というか", answers: ["特区"] },
                { id: 22232, question: "住民の政治参加によって地方自治が行われることを何というか", answers: ["住民自治"] },
                { id: 22233, question: "国政と比べ直接民主主義を実現しやすいことから、地方自治は何といわれているか", answers: ["民主主義の学校"] },
                { id: 22234, question: "首長と議員の両方を住民が直接選挙で選ぶ制度を何というか", answers: ["二元代表制"] },
                { id: 22235, question: "地方自治体が制定、改廃し、その自治体内で適用される法規を何というか", answers: ["条例"] },
                { id: 22236, question: "地方自治体の政策などについて、住民の意思を問うための投票を何というか", answers: ["住民投票", "レフェンダム"] },
                { id: 22237, question: "代理人が住民からの苦情を受け付け、調査分析して行政機関へ勧告する制度は何か", answers: ["オンブズマン制度"] }
            ],
            english: [
                { question: "音色、音調", answer: "tone" },
                { question: "(うっとりと)聞き入る", answer: "take in" },
                { question: "よく考える、注意深く見る", answer: "consider" },
                { question: "(楽譜の)初見歌唱", answer: "sight-read" },
                { question: "クラシックの作品", answer: "classical piece" },
                { question: "合唱団", answer: "choir" },
                { question: "(あきれて)目をぐるっとする", answer: "roll her eyes" },
                { question: "目が見えない", answer: "blind" },
                { question: "言い訳", answer: "excuse" },
                { question: "最悪、マジでひどい", answer: "it sucks" },
                { question: "(ムチのように)パッと振り向く", answer: "whip around" },
                { question: "吐き気がする、最悪", answer: "disgusting" },
                { question: "それは私に期待されていることだ", answer: "it's expected of me" },
                { question: "Vすることがどんなことか", answer: "what it's like to" },
                { question: "(人に対して)埋め合わせする", answer: "make it up" },
                { question: "しつけ、規律、自制心", answer: "discipline" },
                { question: "準備不足だ", answer: "You're unprepared" },
                { question: "2日と続かないだろう", answer: "You wouldn't last two days" },
                { question: "お前は何もわかっていない", answer: "You don't know shit" },
                { question: "間違いなく、確実に", answer: "certainly" },
                { question: "失敗についてのレッスン", answer: "A lesson in failure" },
                { question: "心からの、嘘偽りのない", answer: "genuine" },
                { question: "嫌な；最低なやつだらけ", answer: "full of assholes" },
                { question: "とても疲れる", answer: "exhausting" },
                { question: "イライラさせられた状態", answer: "frustrated" },
                { question: "嵐、猛スピードで移動する", answer: "storm" },
                { question: "免許", answer: "licence" },
                { question: "停止する、中断する", answer: "suspend" },
                { question: "もう釣りは終わった", answer: "We're done fishing" },
                { question: "沿岸警備隊", answer: "coasties" },
                { question: "こっそり教える、密告する", answer: "tip off" },
                { question: "船の甲板で働く人", answer: "deckhand" },
                { question: "解決する、なんとかする", answer: "figure out" },
                { question: "～を責める", answer: "blame" },
                { question: "～を数に入れる、頼る", answer: "count on" },
                { question: "端、角", answer: "edge" },
                { question: "電極", answer: "electrode" },
                { question: "流し", answer: "sink" },
                { question: "洗面台", answer: "sank" },
                { question: "沈む", answer: "sunk" },
                { question: "～を頼る、期待する", answer: "look to" },
                { question: "～することになっている", answer: "be supposed to" },
                { question: "爆発する(ex-)", answer: "explode" },
                { question: "爆発する(er-)", answer: "erupt" },
                { question: "扱われる", answer: "get treated" },
                { question: "無力な、どうすることもできない", answer: "helpless" },
                { question: "会社＜企業＞の", answer: "corporate" },
                { question: "重役", answer: "executive" },
                { question: "riseの過去形", answer: "rose" },
                { question: "階級；等級", answer: "rank" },
                { question: "上位の；上級の", answer: "senior" },
                { question: "慣れている", answer: "used" },
                { question: "～に慣れる", answer: "get used to" },
                { question: "～を知る", answer: "learn" },
                { question: "昇進", answer: "promotion" },
                { question: "取締役の；重役の", answer: "executive" },
                { question: "たとえそうでも；とはいうものの", answer: "that said" },
                { question: "～を印刷する", answer: "print" },
                { question: "～を浸す；～をつける", answer: "steep" },
                { question: "～に浸っている；深い影響を受けている", answer: "be steeped in" },
                { question: "職；仕事", answer: "position" },
                { question: "責任", answer: "responsibility" },
                { question: "肩書；称号；敬称", answer: "title" },
                { question: "何度も；繰り返し", answer: "time and again" },
                { question: "権威；権力；権限", answer: "authority" },
                { question: "野心的な；大規模な", answer: "ambitious" },
                { question: "題材；資料；資材", answer: "material" },
                { question: "その過程で；その間に", answer: "along the way" },
                { question: "詳細な；細かい", answer: "detailed" },
                { question: "見本", answer: "sample" },
                { question: "章", answer: "chapter" },
                { question: "～を売り込む", answer: "shop around" },
                { question: "出版社", answer: "publisher" },
                { question: "《マスコミなどに》取り上げられること", answer: "exposure" },
                { question: "読者", answer: "reader" },
                { question: "無理な要求；骨の折れる課題", answer: "stretch" },
                { question: "～を解決する", answer: "figure out" },
                { question: "ソフトウェア", answer: "software" },
                { question: "～をたどる；～を追跡する", answer: "follow" },
                { question: "特定の", answer: "particular" },
                { question: "題名", answer: "title" },
                { question: "～と(約束して)会う；～と会合を持つ", answer: "meet with" },
                { question: "ダース", answer: "dozen" },
                { question: "(非常に)多くの～", answer: "dozens of" },
                { question: "熱心な", answer: "enthusiastic" },
                { question: "しっかりした；確かな", answer: "sound" },
                { question: "だんだん", answer: "increasingly" },
                { question: "許可", answer: "permission" },
                { question: "～に許可を与える；～を認める", answer: "grant" },
                { question: "動機付け；動機；やる気", answer: "motivation" },
                { question: "力；勢い；強さ；影響力のある人", answer: "force" },
                { question: "空間；場所", answer: "space" },
                { question: "～を拾い集める", answer: "gather up" },
                { question: "～の間に", answer: "over the course of" },
                { question: "《結論・政策など》を徹底的に検討して出す", answer: "hammer out" },
                { question: "《職業上の》同僚", answer: "colleague" },
                { question: "異なって；それぞれに", answer: "differently" },
                { question: "語彙", answer: "vocabulary" },
                { question: "工業技術の；科学技術の", answer: "technical" },
                { question: "学科；学問", answer: "discipline" },
                { question: "生産的な", answer: "productive" },
                { question: "～を例証する", answer: "illustrate" },
                { question: "必要性", answer: "need" },
                { question: "リンク", answer: "link" },
                { question: "移民、移住者", answer: "immigrant" },
                { question: "すべてを考慮に入れると", answer: "all things considered" },
                { question: "当時は", answer: "back then" },
                { question: "政治の", answer: "political" },
                { question: "厳重に、注意深く", answer: "closely" },
                { question: "～だと断言する", answer: "swear" },
                { question: "～にもかかわらず", answer: "despite" },
                { question: "災難、苦しい状況", answer: "trouble" },
                { question: "《人に》起こる", answer: "come one's way" },
                { question: "働いている、仕事中で", answer: "at work" },
                { question: "～を確認する、同定する", answer: "identify" },
                { question: "どうやら～らしい", answer: "apparently" },
                { question: "変わった、奇妙な", answer: "defense" },
                { question: "句、表現、言い回し", answer: "phrase" },
                { question: "きちんと、適切に", answer: "properly" },
                { question: "外国人", answer: "foreigner" },
                { question: "どちらかというと", answer: "kind of" },
                { question: "銃弾", answer: "bullet" },
                { question: "《事故・犯罪などが起きた》現場", answer: "scene" },
                { question: "審議する", answer: "deliberate" },
                { question: "(裁判所の)判決、評決", answer: "decision" },
                { question: "国籍", answer: "nationality" },
                { question: "信条、信念、意見", answer: "belief" },
                { question: "デモをする、示威活動をする", answer: "demonstrate" },
                { question: "調査、取り調べ", answer: "investigation" },
                { question: "電気の", answer: "electronic" },
                { question: "議論", answer: "argument" },
                { question: "～を提案する", answer: "propose" },
                { question: "～するように要求する、命令する", answer: "require" },
                { question: "～を再調査する、見直す", answer: "review" },
                { question: "～を認める", answer: "admit" },
                { question: "記念日", answer: "anniversary" },
                { question: "～から判断すると", answer: "judging from" }
            ],
            kobun: [
                { question: "優美だ。風流だ。上品だ。(やー)", answer: "やさし", kanji: "" },
                { question: "けなげだ。殊勝だ。感心だ。", answer: "やさし", kanji: "" },
                { question: "すぐれている。すばらしい。", answer: "いうなり", kanji: "" },
                { question: "優美だ。風流だ。上品だ。(いー)", answer: "いうなり", kanji: "" },
                { question: "優美だ。優雅だ。しっとりと上品だ。", answer: "なまめかし", kanji: "" },
                { question: "風流だ。物好きだ。", answer: "すきずきし", kanji: "" },
                { question: "色好みだ。浮気だ。好色だ。", answer: "すきずきし", kanji: "" },
                { question: "風情がある。由緒ありげだ。", answer: "ゆゑゆゑし", kanji: "" },
                { question: "《ふるまいなどが》物慣れている。洗練されている。", answer: "らうらうじ", kanji: "" },
                { question: "《容姿などが》気品がある。上品だ。", answer: "らうらうじ", kanji: "" },
                { question: "風情を解する。分別がある。思いやりがある。", answer: "こころあり", kanji: "" },
                { question: "詩歌管弦の遊び。狩り。行楽。", answer: "あそび", kanji: "" },
                { question: "口ずさむ。朗詠する。言葉を口に出して言う。", answer: "うちいづ", kanji: "" },
                { question: "筆跡。字。", answer: "て", kanji: "" },
                { question: "曲。演奏法。", answer: "て", kanji: "" },
                { question: "幼い。あどけない。幼稚だ。", answer: "いはけなし", kanji: "" },
                { question: "道理に合わない。無理だ。", answer: "わりなし", kanji: "" },
                { question: "耐えがたい。つらい。", answer: "わりなし", kanji: "" },
                { question: "どうしようもない。やむをえない。", answer: "わりなし", kanji: "" },
                { question: "並々でない。はなはだしい。", answer: "わりなし", kanji: "" },
                { question: "大げさだ。仰々しい。ひどい。", answer: "おどろおどろし", kanji: "" },
                { question: "不気味だ。騒々しい。", answer: "おどろおどろし", kanji: "" },
                { question: "平気だ。平然としている。素知らぬふりをしている。", answer: "つれなし", kanji: "" },
                { question: "冷淡だ。薄情だ。", answer: "つれなし", kanji: "" },
                { question: "何の変化もない。もとのままだ。", answer: "つれなし", kanji: "" },
                { question: "整っている。きちんとしている。端正だ。", answer: "うるはし", kanji: "" },
                { question: "正式だ。折り目正しい。", answer: "うるはし", kanji: "" },
                { question: "大人らしい。大人びている。", answer: "おとなし", kanji: "" },
                { question: "思慮分別がある。中心的な立場にある。", answer: "おとなし", kanji: "" },
                { question: "場所が狭い。(物が)たくさんある。", answer: "ところせし", kanji: "" },
                { question: "窮屈だ。気づまりだ。", answer: "ところせし", kanji: "" },
                { question: "堂々としている。仰々しい。", answer: "ところせし", kanji: "" },
                { question: "薄情だ。冷淡だ。思いやりがない。", answer: "つらし", kanji: "" },
                { question: "うらめしい。たえられない。つらい。", answer: "つらし", kanji: "" },
                { question: "気が引ける。気恥ずかしい。", answer: "つつまし", kanji: "" },
                { question: "恐ろしい", answer: "かしこし", kanji: "" },
                { question: "おそれ多い。もったいない。尊い。", answer: "かしこし", kanji: "" },
                { question: "すぐれている。利口だ。", answer: "かしこし", kanji: "" },
                { question: "はなはだしく。", answer: "かしこし", kanji: "" },
                { question: "もの足りない。心さみしい。つまらない。", answer: "さうざうし", kanji: "" },
                { question: "ふさわしい。似つかわしい。似合う。", answer: "つきづきし", kanji: "" },
                { question: "もっともらしい。", answer: "つきづきし", kanji: "" },
                { question: "ふさわしくない。似つかわしくない。似合わない。", answer: "つきなし", kanji: "" },
                { question: "不愉快だ。目障りだ。気に食わない。", answer: "ものし", kanji: "" },
                { question: "無礼だ。不作法だ。", answer: "なめし", kanji: "" },
                { question: "すばらしい。立派だ。", answer: "めでたし", kanji: "" },
                { question: "かわいそうだ。気の毒だ。", answer: "いとほし", kanji: "" },
                { question: "かわいい。いとしい。", answer: "いとほし", kanji: "" },
                { question: "ものさびしい。恐ろしい。寒々としている。", answer: "すごし", kanji: "" },
                { question: "気に食わない。しゃくにさわる。", answer: "めざまし", kanji: "" },
                { question: "意外と素晴らしい。思いがけず立派だ。", answer: "めざまし", kanji: "" },
                { question: "不快だ。うっとうしい。", answer: "むつかし", kanji: "" },
                { question: "わずらわしい。やっかいだ。面倒だ。", answer: "むつかし", kanji: "" },
                { question: "気味悪い。", answer: "むつかし", kanji: "" }
            ]
        };

        // --- App State ---
        let allData = {};
        let quizItems = [];
        let currentQuizMode = null;
        let currentStartScreen = null;
        let currentQuestionIndex = 0;
        let score = 0;
        let masteryStatus = {};
        let masteredBeforeQuiz = 0;
        let onConfirmAction = null;

        // --- DOM Elements ---
        const appContainer = document.getElementById('app-container');
        const modeSelectionScreen = document.getElementById('mode-selection-screen');
        const startScreenTemplate = document.getElementById('start-screen-template');
        const quizScreen = document.getElementById('quiz-screen');
        const resultScreen = document.getElementById('result-screen');
        
        const quizTitle = document.getElementById('quiz-title');
        const questionCounter = document.getElementById('question-counter');
        const questionText = document.getElementById('question-text');
        const userInput = document.getElementById('user-input');
        const checkBtn = document.getElementById('check-btn');
        const nextBtn = document.getElementById('next-btn');
        const feedback = document.getElementById('feedback');
        const scoreText = document.getElementById('score-text');
        const scoreMessage = document.getElementById('score-message');
        const masteryCount = document.getElementById('mastery-count');
        const resultsList = document.getElementById('results-list');
        const downloadCsvBtn = document.getElementById('download-csv-btn');
        const downloadPdfBtn = document.getElementById('download-pdf-btn');
        const playAgainBtn = document.getElementById('play-again-btn');
        const confirmModal = document.getElementById('confirm-modal');
        const confirmMessage = document.getElementById('confirm-message');
        const confirmOkBtn = document.getElementById('confirm-ok-btn');
        const confirmCancelBtn = document.getElementById('confirm-cancel-btn');
        const alertModal = document.getElementById('alert-modal');
        const alertMessage = document.getElementById('alert-message');
        const alertOkBtn = document.getElementById('alert-ok-btn');
        const themeToggle = document.getElementById('checkbox');

        // --- LocalStorage Functions ---
        const getLocalStorage = (key) => {
            try {
                const data = localStorage.getItem(key);
                return data ? JSON.parse(data) : {};
            } catch (e) {
                console.error("ローカルストレージの読み込みに失敗:", e);
                return {};
            }
        };
        const setLocalStorage = (key, value) => {
            try {
                localStorage.setItem(key, JSON.stringify(value));
            } catch (e) {
                console.error("ローカルストレージへの保存に失敗:", e);
            }
        };

        // --- Helper Functions ---
        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }

        // 解答の正規化（モードによって処理を変える）
        function normalizeAnswer(str, mode) {
            if (typeof str !== 'string') return '';
            
            // 全角文字を半角に変換
            let normalized = str.trim()
                .replace(/[Ａ-Ｚａ-ｚ０-９．＝－（）『』]/g, s => String.fromCharCode(s.charCodeAt(0) - 0xFEE0))
                .replace(/　/g, ' ') // 全角スペースを半角に
                .replace(/[〜～]/g, '-') 
                .replace(/＝/g, '=');

            // 英語モード以外なら、すべてのスペースを削除（日本語入力の揺らぎ吸収）
            // 英語モードなら、単語間のスペースは重要なので残す（ただし前後の空白はtrim済み）
            if (mode !== 'english') {
                normalized = normalized.replace(/ /g, '');
            } else {
                // 英語の場合は小文字化するが、内部のスペースは維持する
                normalized = normalized.toLowerCase();
            }

            return normalized;
        }

        // --- Modal ---
        function showAlertModal(message) {
            alertMessage.textContent = message;
            alertModal.classList.remove('hidden');
        }
        function hideAlertModal() { alertModal.classList.add('hidden'); }
        function showConfirmModal(message, onConfirm) {
            confirmMessage.textContent = message;
            onConfirmAction = onConfirm;
            confirmModal.classList.remove('hidden');
        }
        function hideConfirmModal() {
            confirmModal.classList.add('hidden');
            onConfirmAction = null;
        }

        // --- Screen Management ---
        function showScreen(screen) {
            const screens = document.querySelectorAll('#app-container > div');
            screens.forEach(s => s.classList.add('hidden'));
            screen.classList.remove('hidden');
            currentStartScreen = (screen.id.includes('-start-screen')) ? screen : null;
        }
        
        // --- Mastery and Stats Logic ---
        function createStartScreen(mode, title) {
            const screen = startScreenTemplate.cloneNode(true);
            screen.id = `${mode}-start-screen`;
            screen.querySelector('.start-title').textContent = title;
            screen.querySelector('.mastery-stats').id = `${mode}-mastery-stats`;
            screen.querySelector('.start-quiz-btn[data-length-type="10"]').dataset.mode = mode;
            screen.querySelector('.start-quiz-btn[data-length-type="all"]').dataset.mode = mode;
            screen.querySelector('.reset-history-btn').dataset.mode = mode;
            screen.querySelector('.reset-feedback').id = `reset-${mode}-feedback`;
            appContainer.appendChild(screen);
        }

        function updateMasteryStats(mode) {
            const data = allData[mode];
            const statusData = masteryStatus[mode];
            const container = document.getElementById(`${mode}-mastery-stats`);
            if (!container) return;
            
            container.innerHTML = `
                <div><p class="text-2xl font-bold text-sky-400" id="${mode}-unattempted-count">0</p><p class="text-xs text-secondary">未実施</p></div>
                <div><p class="text-2xl font-bold text-red-400" id="${mode}-unlearned-count">0</p><p class="text-xs text-secondary">未習得</p></div>
                <div><p class="text-2xl font-bold text-amber-400" id="${mode}-checking-count">0</p><p class="text-xs text-secondary">点検中</p></div>
                <div><p class="text-2xl font-bold text-green-400" id="${mode}-mastered-count">0</p><p class="text-xs text-secondary">習得</p></div>
            `;
            const counts = { '未実施': 0, '未習得': 0, '点検中': 0, '習得': 0 };
            data.forEach(item => {
                const status = statusData[item.id] || '未実施';
                counts[status]++;
            });
            document.getElementById(`${mode}-unattempted-count`).textContent = counts['未実施'];
            document.getElementById(`${mode}-unlearned-count`).textContent = counts['未習得'];
            document.getElementById(`${mode}-checking-count`).textContent = counts['点検中'];
            document.getElementById(`${mode}-mastered-count`).textContent = counts['習得'];
        }

        function resetHistory(mode) {
            const modeTitleMap = { english: '英単語', public: '公共', kobun: '古文単語' };
            const modeTitle = modeTitleMap[mode] || 'クイズ';
            const message = `${modeTitle}の学習履歴をすべてリセットしますか？`;
            showConfirmModal(message, () => {
                masteryStatus[mode] = {};
                setLocalStorage(`${mode}MasteryStatus`, {});
                updateMasteryStats(mode);
                const feedbackEl = document.getElementById(`reset-${mode}-feedback`);
                feedbackEl.textContent = '履歴をリセットしました。';
                setTimeout(() => { feedbackEl.textContent = ''; }, 2000);
            });
        }
        
        function downloadUnlearnedCSV() {
            const data = allData[currentQuizMode];
            const statusData = masteryStatus[currentQuizMode];

            const unlearnedItems = data.filter(item => statusData[item.id] === '未習得');
            if (unlearnedItems.length === 0) { showAlertModal("未習得の項目はありません。"); return; }
            
            let headers, body;
            switch(currentQuizMode) {
                case 'english':
                    headers = "日本語,English\r\n";
                    body = unlearnedItems.map(item => `"${item.question}","${item.answer}"`).join('\r\n');
                    break;
                case 'kobun':
                    headers = "問題,答え,漢字\r\n";
                    body = unlearnedItems.map(item => `"${item.question}","${item.answer}","${item.kanji || ''}"`).join('\r\n');
                    break;
                case 'public':
                    headers = "問題,解答\r\n";
                    body = unlearnedItems.map(item => `"${item.question}","${item.answers.join(' / ')}"`).join('\r\n');
                    break;
            }
            let csvContent = "data:text/csv;charset=utf-8,\uFEFF" + headers + body;

            const link = document.createElement("a");
            link.setAttribute("href", encodeURI(csvContent));
            link.setAttribute("download", `unlearned_${currentQuizMode}.csv`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        async function downloadUnlearnedPDF() {
            const data = allData[currentQuizMode];
            const statusData = masteryStatus[currentQuizMode];
            
            const unlearnedItems = data.filter(item => statusData[item.id] === '未習得');
            if (unlearnedItems.length === 0) { showAlertModal("未習得の項目はありません。"); return; }

            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            try {
                showAlertModal("PDFを生成中です...");
                 doc.setFont("Helvetica"); 
                 let y = 15;
                 doc.text("Unlearned Items List", 14, y);
                 y += 10;
                 
                 unlearnedItems.forEach(item => {
                     if (y > 280) { doc.addPage(); y = 15; }
                     let textLine = '';
                     switch(currentQuizMode) {
                        case 'english':
                            textLine = `${item.question}: ${item.answer}`;
                            break;
                        case 'kobun':
                            textLine = `${item.question}: ${item.answer} [${item.kanji || ''}]`;
                            break;
                        default:
                            textLine = `${item.question}: ${item.answers.join(' / ')}`;
                            break;
                     }
                     const splitText = doc.splitTextToSize(textLine, 180);
                     doc.text(splitText, 14, y);
                     y += (splitText.length * 7);
                 });
                doc.save(`unlearned_${currentQuizMode}.pdf`);
            } catch (e) {
                console.error("PDF生成エラー:", e);
                showAlertModal("PDFの生成に失敗しました。");
            } finally {
                hideAlertModal();
            }
        }

        // --- Core Quiz Logic ---
        function startQuiz(mode, lengthType) {
            currentQuizMode = mode;
            score = 0;
            currentQuestionIndex = 0;
            
            const data = allData[mode];
            const statusData = masteryStatus[mode];
            masteredBeforeQuiz = Object.values(statusData).filter(s => s === '習得').length;

            const unattempted = data.filter(item => !statusData[item.id] || statusData[item.id] === '未実施');
            const unlearned = data.filter(item => statusData[item.id] === '未習得');
            const checking = data.filter(item => statusData[item.id] === '点検中');
            const mastered = data.filter(item => statusData[item.id] === '習得');

            let pool = [...shuffleArray(unattempted), ...shuffleArray(unlearned)];
            
            if (lengthType === 'all') {
                pool.push(...shuffleArray(checking));
                quizItems = shuffleArray(pool);
            } else { // '10'
                if (pool.length < 10) pool.push(...shuffleArray(checking));
                if (pool.length < 10) pool.push(...shuffleArray(mastered));
                quizItems = shuffleArray(pool).slice(0, Math.min(10, data.length));
            }
            
            if (quizItems.length === 0) {
                 showAlertModal("出題できる問題がありません！");
                 return;
            }

            showScreen(quizScreen);
            displayQuestion();
        }

        function displayQuestion() {
            if (currentQuestionIndex >= quizItems.length) {
                showResults();
                return;
            }
            const currentItem = quizItems[currentQuestionIndex];
            const modeTitleMap = { english: '英単語クイズ', public: '公共テスト', kobun: '古文単語クイズ' };
            quizTitle.textContent = modeTitleMap[currentQuizMode];
            questionCounter.textContent = `問題 ${currentQuestionIndex + 1} / ${quizItems.length}`;
            questionText.textContent = currentItem.question;
            
            userInput.value = '';
            userInput.disabled = false;
            userInput.focus();
            feedback.innerHTML = '';
            checkBtn.classList.remove('hidden');
            nextBtn.classList.add('hidden');
        }

        function checkAnswer() {
            const userAnswer = userInput.value.trim();
            const currentItem = quizItems[currentQuestionIndex];
            userInput.disabled = true;

            let isCorrect = false;
            let correctAnswersText = '';
            const statusData = masteryStatus[currentQuizMode];
            const storageKey = `${currentQuizMode}MasteryStatus`;

            if (currentQuizMode === 'english' || currentQuizMode === 'kobun') {
                correctAnswersText = currentItem.answer;
                // ここでモードごとの正規化を適用
                isCorrect = normalizeAnswer(userAnswer, currentQuizMode) === normalizeAnswer(correctAnswersText, currentQuizMode);
            } else { // public
                correctAnswersText = currentItem.answers.join(' / ');
                const normalizedUserAnswer = normalizeAnswer(userAnswer, currentQuizMode);
                isCorrect = currentItem.answers.some(ans => normalizeAnswer(ans, currentQuizMode) === normalizedUserAnswer);
            }
            
            const itemId = currentItem.id;
            const currentStatus = statusData[itemId] || '未実施';
            let feedbackHtml = '';

            if (isCorrect && userAnswer.length > 0) {
                score++;
                feedbackHtml = `<p class="text-green-400 font-bold text-lg">正解！</p>`;
                if (currentStatus === '未実施' || currentStatus === '未習得') statusData[itemId] = '点検中';
                else if (currentStatus === '点検中') statusData[itemId] = '習得';
            } else {
                feedbackHtml = `<p class="text-red-400 font-bold text-lg">不正解...</p><p class="text-secondary">正解は: <span class="font-bold text-primary">${correctAnswersText}</span></p>`;
                statusData[itemId] = '未習得';
            }
            
            if (currentQuizMode === 'kobun' && currentItem.kanji) {
                feedbackHtml += `<p class="text-sky-400 mt-1">【漢字】 ${currentItem.kanji}</p>`;
            }
            feedback.innerHTML = feedbackHtml;

            setLocalStorage(storageKey, statusData);
            
            checkBtn.classList.add('hidden');
            nextBtn.classList.remove('hidden');
            nextBtn.focus();
        }
        
        function showResults() {
            showScreen(resultScreen);
            scoreText.textContent = `${score} / ${quizItems.length}`;
            let message = '';
            if (score === quizItems.length) message = '素晴らしい！全問正解です！';
            else if (score >= quizItems.length * 0.7) message = '良い調子ですね！';
            else if (score >= quizItems.length * 0.4) message = 'もう少し！頑張りましょう。';
            else message = '次はもっと頑張ろう！';
            scoreMessage.textContent = message;

            resultsList.innerHTML = '';
            quizItems.forEach(item => {
                const listItem = document.createElement('div');
                listItem.className = 'results-list-item';
                const question = item.question;
                const answer = (currentQuizMode === 'public') ? item.answers.join(' / ') : item.answer;
                listItem.innerHTML = `
                    <span class="text-secondary w-2/3 truncate">${question}</span>
                    <span class="font-bold w-1/3 text-right">${answer}</span>`;
                resultsList.appendChild(listItem);
            });
            
            const data = allData[currentQuizMode];
            const statusData = masteryStatus[currentQuizMode];
            
            const learnedCount = Object.values(statusData).filter(s => s === '習得').length;
            const change = learnedCount - masteredBeforeQuiz;
            const changeString = change > 0 ? `+${change}` : (change < 0 ? `${change}` : `${change}`);
            masteryCount.innerHTML = `現在の習得数: <span class="font-bold text-xl">${learnedCount}</span> / ${data.length} <span class="text-sm">(前回比: ${changeString})</span>`;
        }

        // --- Initialization and Event Listeners ---
        function initializeAllData() {
            // Process English (Simple array)
            allData.english = DATA_SETS.english.map((item, index) => ({ ...item, id: index }));

            // Process Public Affairs
            allData.public = DATA_SETS.public.map(q => ({...q}));
            
            // Process Kobun
            allData.kobun = DATA_SETS.kobun.map((item, index) => ({ ...item, id: index }));
            
            // Load mastery from localStorage for all modes
            Object.keys(DATA_SETS).forEach(mode => {
                const data = allData[mode];
                const savedStatus = getLocalStorage(`${mode}MasteryStatus`) || {};
                const validIds = new Set(data.map(item => item.id));
                Object.keys(savedStatus).forEach(id => {
                    if (!validIds.has(parseInt(id, 10))) delete savedStatus[id];
                });
                masteryStatus[mode] = savedStatus;
                setLocalStorage(`${mode}MasteryStatus`, savedStatus);
            });
        }
        
        document.addEventListener('DOMContentLoaded', () => {
            initializeAllData();
            
            const titleMap = { english: '英単語クイズ', public: '公共テスト', kobun: '古文単語クイズ' };
            Object.keys(DATA_SETS).forEach(mode => createStartScreen(mode, titleMap[mode]));

            document.body.addEventListener('click', (e) => {
                const target = e.target;
                if (target.matches('.mode-select-btn')) {
                    const mode = target.dataset.mode;
                    updateMasteryStats(mode);
                    showScreen(document.getElementById(`${mode}-start-screen`));
                } else if (target.matches('.start-quiz-btn')) {
                    const mode = target.dataset.mode;
                    const lengthType = target.dataset.lengthType;
                    startQuiz(mode, lengthType);
                } else if (target.matches('.reset-history-btn')) {
                    const mode = target.dataset.mode;
                    resetHistory(mode);
                } else if (target.matches('.back-to-mode-selection')) {
                    showScreen(modeSelectionScreen);
                }
            });
            
            const currentTheme = localStorage.getItem('theme');
            if (currentTheme === 'dark') {
                document.documentElement.classList.add('dark');
                themeToggle.checked = true;
            }
            showScreen(modeSelectionScreen);
        });

        // Quiz Flow Listeners
        checkBtn.addEventListener('click', checkAnswer);
        nextBtn.addEventListener('click', () => { currentQuestionIndex++; displayQuestion(); });
        playAgainBtn.addEventListener('click', () => {
            updateMasteryStats(currentQuizMode);
            showScreen(currentStartScreen);
        });
        userInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
                e.preventDefault();
                if (!checkBtn.classList.contains('hidden')) checkBtn.click();
                else if (!nextBtn.classList.contains('hidden')) nextBtn.click();
            }
        });

        // Other Listeners
        downloadCsvBtn.addEventListener('click', downloadUnlearnedCSV);
        downloadPdfBtn.addEventListener('click', downloadUnlearnedPDF);
        confirmOkBtn.addEventListener('click', () => { if (onConfirmAction) { onConfirmAction(); hideConfirmModal(); } });
        confirmCancelBtn.addEventListener('click', hideConfirmModal);
        alertOkBtn.addEventListener('click', hideAlertModal);
        
        themeToggle.addEventListener('change', function() {
            if(this.checked) {
                document.documentElement.classList.add('dark');
                localStorage.setItem('theme', 'dark');
            } else {
                document.documentElement.classList.remove('dark');
                localStorage.setItem('theme', 'light');
            }
        });
        
    </script>
</body>
</html>
