<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>単語・一問一答クイズ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+JP:wght@400;500;700&display=swap" rel="stylesheet">
    <!-- PDF生成ライブラリ -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
    <style>
        :root {
            --bg-primary: #f1f5f9; /* slate-100 */
            --bg-secondary: #ffffff; /* white */
            --bg-tertiary: #e2e8f0; /* slate-200 */
            --text-primary: #0f172a; /* slate-900 */
            --text-secondary: #64748b; /* slate-500 */
            --border-color: #cbd5e1; /* slate-300 */
            --card-bg: #ffffff;
            --input-bg: #f8fafc; /* slate-50 */
            --input-border: #cbd5e1; /* slate-300 */
        }
        .dark {
            --bg-primary: #0f172a; /* slate-900 */
            --bg-secondary: #1e293b; /* slate-800 */
            --bg-tertiary: #0f172a; /* slate-900 */
            --text-primary: #f8fafc; /* slate-50 */
            --text-secondary: #94a3b8; /* slate-400 */
            --border-color: #334155; /* slate-700 */
            --card-bg: #1e293b;
            --input-bg: #334155; /* slate-700 */
            --input-border: #475569; /* slate-600 */
        }
        body {
            font-family: 'Inter', 'Noto Sans JP', sans-serif;
            background-color: var(--bg-primary);
            color: var(--text-primary);
            transition: background-color 0.3s, color 0.3s;
        }
        .card {
            background-color: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 0.75rem;
            padding: 2rem;
            box-shadow: 0 20px 25px -5px rgb(0 0 0 / 0.1), 0 8px 10px -6px rgb(0 0 0 / 0.1);
            transition: all 0.3s ease-in-out;
        }
        .hidden { display: none; }
        .btn {
            display: inline-block;
            font-weight: 600;
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            transition: all 0.2s ease-in-out;
            cursor: pointer;
            text-align: center;
        }
        .btn-primary { background-color: #4f46e5; color: white; }
        .btn-primary:hover { background-color: #4338ca; }
        .btn-secondary { background-color: #475569; color: white; }
        .btn-secondary:hover { background-color: #64748b; }
        .results-list-item {
            display: flex;
            justify-content: space-between;
            padding: 0.5rem 0;
            border-bottom: 1px solid var(--border-color);
        }
        .results-list-item:last-child { border-bottom: none; }
        .modal {
            position: fixed; inset: 0; background-color: rgba(0, 0, 0, 0.75);
            display: flex; align-items: center; justify-content: center;
            padding: 1rem; z-index: 50;
        }
        #user-input {
            background-color: var(--input-bg);
            border-color: var(--input-border);
        }
        #question-text-container {
             background-color: var(--bg-tertiary);
        }
        .theme-switch-wrapper {
            display: flex;
            align-items: center;
            position: fixed;
            top: 1rem;
            right: 1rem;
        }
        .theme-switch {
            display: inline-block;
            height: 24px;
            position: relative;
            width: 48px;
        }
        .theme-switch input {
            display:none;
        }
        .slider {
            background-color: #475569;
            bottom: 0;
            cursor: pointer;
            left: 0;
            position: absolute;
            right: 0;
            top: 0;
            transition: .4s;
        }
        .slider:before {
            background-color: #fff;
            bottom: 4px;
            content: "";
            height: 16px;
            left: 4px;
            position: absolute;
            transition: .4s;
            width: 16px;
        }
        input:checked + .slider {
            background-color: #4f46e5;
        }
        input:checked + .slider:before {
            transform: translateX(24px);
        }
        .slider.round {
            border-radius: 34px;
        }
        .slider.round:before {
            border-radius: 50%;
        }
    </style>
</head>
<body class="flex items-center justify-center min-h-screen p-4">

    <div class="theme-switch-wrapper">
      <label class="theme-switch" for="checkbox">
        <input type="checkbox" id="checkbox" />
        <div class="slider round"></div>
      </label>
    </div>

    <div class="w-full max-w-xl">
        <!-- Main App Container -->
        <div id="app-container" class="card">
            <!-- Mode Selection Screen -->
            <div id="mode-selection-screen">
                <h1 class="text-3xl font-bold text-center mb-2">クイズ選択</h1>
                <p class="text-center text-slate-400 mb-8">挑戦するクイズを選んでください。</p>
                <div class="space-y-4">
                    <button id="select-english-btn" class="btn btn-primary w-full">英単語クイズ</button>
                    <button id="select-public-btn" class="btn btn-primary w-full">公共テスト</button>
                    <button id="select-kobun-btn" class="btn btn-primary w-full">古文単語クイズ</button>
                </div>
            </div>

            <!-- Start Screens (one for each mode) -->
            <div id="english-start-screen" class="hidden"></div>
            <div id="public-start-screen" class="hidden"></div>
            <div id="kobun-start-screen" class="hidden"></div>

            <!-- Quiz Screen -->
            <div id="quiz-screen" class="hidden">
                <div class="flex justify-between items-center mb-6">
                    <h2 id="quiz-title" class="text-xl font-bold">クイズ</h2>
                    <p id="question-counter" class="text-slate-400 font-medium"></p>
                </div>
                <div id="question-text-container" class="p-6 rounded-lg mb-6 min-h-[100px] flex items-center justify-center">
                    <p id="question-text" class="text-2xl md:text-3xl font-bold text-center"></p>
                </div>
                <div class="space-y-4">
                    <input type="text" id="user-input" placeholder="解答を入力..." class="w-full border rounded-md px-4 py-3 text-primary focus:outline-none focus:ring-2 focus:ring-indigo-500" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false">
                    <button id="check-btn" class="btn btn-primary w-full">解答をチェック</button>
                    <button id="next-btn" class="btn btn-secondary w-full hidden">次の問題へ</button>
                </div>
                <div id="feedback" class="mt-6 text-center min-h-[4rem]"></div>
            </div>

            <!-- Result Screen -->
            <div id="result-screen" class="hidden text-center">
                <h2 class="text-2xl font-bold mb-4">結果発表</h2>
                <p class="text-5xl font-bold mb-2" id="score-text"></p>
                <p class="text-slate-400 mb-6" id="score-message"></p>
                <div id="mastery-results-extra">
                    <div class="bg-secondary rounded-lg p-4 mb-6">
                        <p class="text-lg" id="mastery-count"></p>
                    </div>
                </div>
                <div id="results-details" class="text-left mb-6 max-h-60 overflow-y-auto">
                    <h3 class="font-bold text-lg mb-2">出題一覧</h3>
                    <div id="results-list" class="space-y-2"></div>
                </div>
                <button id="play-again-btn" class="btn btn-primary w-full">もう一度挑戦する</button>
                <div id="download-buttons" class="mt-4 flex flex-col sm:flex-row space-y-2 sm:space-y-0 sm:space-x-4">
                    <button id="download-csv-btn" class="btn btn-secondary w-full">未習得リストをCSVで保存</button>
                    <button id="download-pdf-btn" class="btn btn-secondary w-full">未習得リストをPDFで保存</button>
                </div>
                 <button class="back-to-mode-selection btn btn-secondary w-full mt-4">モード選択に戻る</button>
            </div>
        </div>
        <footer class="text-center mt-4 text-xs text-secondary">
            <p>学習を頑張りましょう！</p>
        </footer>
    </div>
    
    <!-- Modals -->
    <div id="confirm-modal" class="hidden modal">
        <div class="card p-6 max-w-sm w-full text-center shadow-xl">
            <p id="confirm-message" class="mb-6"></p>
            <div class="flex justify-center space-x-4">
                <button id="confirm-cancel-btn" class="btn btn-secondary w-1/2">キャンセル</button>
                <button id="confirm-ok-btn" class="btn w-1/2 !bg-red-800 hover:!bg-red-700">OK</button>
            </div>
        </div>
    </div>
    <div id="alert-modal" class="hidden modal">
        <div class="card p-6 max-w-sm w-full text-center shadow-xl">
            <p id="alert-message" class="mb-6"></p>
            <div class="flex justify-center">
                <button id="alert-ok-btn" class="btn btn-primary w-1/2">OK</button>
            </div>
        </div>
    </div>

    <script>
        // --- DATA ---
        const DATA_SETS = {
            english: [
                { answer: "interest", question: "利益；利子；重要性；興味" }, { answer: "aggressive", question: "攻撃的な；積極的な" }, { answer: "attack", question: "攻撃；非難；発作" }, { answer: "hostile", question: "敵意を持った；相反する" }, { answer: "kick", question: "蹴る" }, { answer: "clothes", question: "衣服" }, { answer: "laundry", question: "洗濯物；クリーニング屋" }, { answer: "needle", question: "針" }, { answer: "reduction", question: "減少" }, { answer: "diminish", question: "減少させる" }, { answer: "discount", question: "割引率；割引する；軽視する" }, { answer: "helpful", question: "親切な；役に立つ" }, { answer: "useless", question: "役に立たない" }, { answer: "selfish", question: "利己的な" }, { answer: "youth", question: "若者；若さ；青年時代" }, { answer: "expose", question: "さらす；暴露する" }, { answer: "shelter", question: "保護する；住まい；避難所" }, { answer: "male", question: "男性の；雄の" }, { answer: "prefer", question: "を好む" }, { answer: "shoot", question: "撃つ" }, { answer: "adventure", question: "冒険" }, { answer: "venture", question: "冒険的事業；思い切って～する" }, { answer: "expedition", question: "遠征；探検隊；小旅行" }, { answer: "strategy", question: "戦略；方策" }, { answer: "survey", question: "調査；概観" }, { answer: "profile", question: "の概略を示す；輪郭；横顔" }, { answer: "board", question: "板；委員会；に搭乗する" }, { answer: "sail", question: "航行する；帆；航海" }, { answer: "electronic", question: "電子(工学)の" }, { answer: "automatic", question: "自動の；無意識的認識" }, { answer: "digital", question: "デジタル式の" }, { answer: "opportunity", question: "機会" }, { answer: "occasion", question: "機会；行事；場合" }, { answer: "chance", question: "機会；偶然；見込み" }, { answer: "career", question: "職業；経歴" }, { answer: "sale", question: "販売；売上層；特売" }, { answer: "retail", question: "小売り" }, { answer: "note", question: "に言及する；に注意する；に気づく；メモ；注釈；紙幣" }, { answer: "cash", question: "現金" }, { answer: "purse", question: "財布；ハンドバッグ" }, { answer: "wallet", question: "札入れ" }, { answer: "communication", question: "伝達；意思疎通；通信" }, { answer: "chat", question: "おしゃべり" }, { answer: "cooperation", question: "協力" }, { answer: "joint", question: "共同の；接合；継ぎ目；関節" }, { answer: "rather", question: "むしろ；かなり；やや" }, { answer: "billion", question: "10億" }, { answer: "indication", question: "兆候；指示" }, { answer: "engage", question: "(他)引き付ける；雇う；従事させる；婚約させる" }, { answer: "contract", question: "を契約する；(病気に)かかる；を縮める；契約書" }, { answer: "promise", question: "約束する；約束；見込み" }, { answer: "frontier", question: "未開拓分野；最先端；国境；辺境" }, { answer: "border", question: "境界；国境" }, { answer: "boundary", question: "境界線；限界" }, { answer: "transfer", question: "を移動させる；を転勤させる；乗り換える；転任する" }, { answer: "transplant", question: "を移動させる；を移植する" }, { answer: "fascinate", question: "を魅了する" }, { answer: "innovative", question: "革新的な" }, { answer: "conclude", question: "と結論づける；を終える" }, { answer: "uniform", question: "同一の；均等の" }, { answer: "union", question: "連合；組合" }, { answer: "unit", question: "1個；1人；単位" }, { answer: "bilingual", question: "2か国語を話す人" }, { answer: "triangle", question: "三角形" }, { answer: "approach", question: "取り組み方；接近方法；近づく" }, { answer: "positive", question: "よい；肯定的な；積極的な；確信して" }, { answer: "negative", question: "悪い；否定的な；消極的な" }, { answer: "quick", question: "素早い" }, { answer: "willing", question: "～する気がある；喜んで行う" }, { answer: "reluctant", question: "気の進まない" }, { answer: "responsibility", question: "責任" }, { answer: "undertake", question: "を引き受ける；に着手する" }, { answer: "commit", question: "(真剣に)かかわる；犯す" }, { answer: "crime", question: "犯罪" }, { answer: "guilty", question: "罪悪感を覚える；有罪の" }, { answer: "innocent", question: "無罪の；無邪気な" }, { answer: "position", question: "立場；状況；姿勢；位置" }, { answer: "pose", question: "をもたらす；ポーズをとる" }, { answer: "opinion", question: "意見" }, { answer: "difficulty", question: "困難さ" }, { answer: "ease", question: "容易さ；安楽さ；を和げる；を取り除く" }, { answer: "flexible", question: "柔軟な" }, { answer: "rigid", question: "堅い；厳格な" }, { answer: "view", question: "見解；眺め；視野；を見る；を考える" }, { answer: "perspective", question: "観点；遠近法；見通し" }, { answer: "landscape", question: "風景" }, { answer: "scene", question: "光景；場面；現場" }, { answer: "arise", question: "起きる；起因する" }, { answer: "derive", question: "由来する；を得る" }, { answer: "stem", question: "生じる；由来する；茎" }, { answer: "lead", question: "通じる；を導く；を率いる；(生活)を送る；首位；先導" }, { answer: "guide", question: "案内する；指導する；案内人；指導者；指針" }, { answer: "delay", question: "遅延；延期；のろのろする" }, { answer: "postpone", question: "を延期する" }, { answer: "prolong", question: "を延長する" }, { answer: "highlight", question: "を強調する；に光を当てる" }, { answer: "shadow", question: "影" }, { answer: "shade", question: "陰；色合い" }, { answer: "clever", question: "利口な；器用な" }, { answer: "decade", question: "10年間" }, { answer: "millennium", question: "1000年" }, { answer: "railroad", question: "鉄道(線路)" }, { answer: "railway", question: "鉄道" }, { answer: "vital", question: "不可欠な；致命的な；生き生きした" }, { answer: "center", question: "中心；中央" }, { answer: "core", question: "中心；核心；果物の芯" }, { answer: "reverse", question: "を逆にする；を一変させる" }, { answer: "automobile", question: "自動車" }, { answer: "wheel", question: "(自動車の)ハンドル；車輪" }, { answer: "countryside", question: "地方；田舎；田園地帯" }, { answer: "rural", question: "田舎の" }, { answer: "urban", question: "都市の" }, { answer: "downtown", question: "町の中心街" }, { answer: "suburb", question: "郊外" }, { answer: "largely", question: "ほとんど；主として" }, { answer: "mainly", question: "主として" }, { answer: "sweep", question: "一掃する；掃除；殺到する" }, { answer: "miss", question: "を逃す；がいなくて寂しく思う；失敗" }, { answer: "loss", question: "紛失；損害；死；敗北" }, { answer: "remain", question: "依然～のままである；～にとどまる；残り；遺跡" }, { answer: "stick", question: "固執する；くっつく；刺さる；行き詰まる；貼り付ける：刺す；棒切れ" }, { answer: "archaeologist", question: "考古学者" }, { answer: "market", question: "市場" }, { answer: "device", question: "機器" }, { answer: "screen", question: "《テレビなどの》画面" }, { answer: "power", question: "能力" }, { answer: "originate", question: "生じる；起こる；起源がある" }, { answer: "of all time", question: "今までで(一番～だ)＜成句＞" }, { answer: "producer", question: "製造者；生産者" }, { answer: "struggle", question: "もがく；あがく" }, { answer: "employ", question: "～を雇う" }, { answer: "maintain", question: "～を整備(保守)する" }, { answer: "mechanical", question: "機械の；機械仕掛けの" }, { answer: "success", question: "うまくいった事；大当たり" }, { answer: "in charge of", question: "～の担当で＜成句＞" }, { answer: "competitor", question: "競争相手；競合企業" }, { answer: "break through", question: "突破する；成功する＜成句＞" }, { answer: "inspiration", question: "素晴らしい発想；ひらめき" }, { answer: "kill time", question: "何かを待ちながら空いた時間をつぶす＜成句＞" }, { answer: "budget", question: "予算" }, { answer: "hit upon", question: "～をふと思いつく＜成句＞" }, { answer: "physician", question: "医者；内科医" }, { answer: "whereas", question: "～だが一方；～であるのに" }, { answer: "improvement", question: "改善；改良" }, { answer: "present", question: "現在" }, { answer: "creativity", question: "創造性" }, { answer: "refer", question: "～を表す；示す" }, { answer: "available", question: "入手できる" }, { answer: "reasonable", question: "《価格が》手頃な" }, { answer: "be in use", question: "使われている＜成句＞" }, { answer: "corporation", question: "企業；株式会社" }, { answer: "competition", question: "競争" }, { answer: "drive", question: "《経済や市場など》を動かす" }, { answer: "equip", question: "～を備え付ける；装備する" }, { answer: "control", question: "制御" }, { answer: "movement", question: "動き" }, { answer: "revolution", question: "革命" }, { answer: "adopt", question: "～を採用する；取り入れる" }, { answer: "component", question: "部品；構成要素" }, { answer: "accessible", question: "利用できる" }, { answer: "come together", question: "《人が》集まる＜成句＞" }, { answer: "come out on top", question: "トップに立つ；戦いに勝つ＜成句＞" }, { answer: "a touch of", question: "ほんの少しの～＜成句＞" }, { answer: "pass away", question: "亡くなる＜成句＞" }, { answer: "just as", question: "～する時；～と同時に＜成句＞" }, { answer: "be about to do", question: "まさに～するところである＜成句＞" }, { answer: "reflect", question: "～を反映する" }, { answer: "innovation", question: "革新；新しいアイディア" }, { answer: "globe", question: "世界；地球；地球儀" },
            ],
            public: [
                { id: 1301, question: "国王が絶対的な権力をもつ政治体制を何というか", answers: ["絶対王政"] }, { id: 1302, question: "国王の権力は神から授かったものだとする考え方を何というか", answers: ["王権神授説"] }, { id: 1303, question: "市民が国王から政治権力を奪取することを何というか", answers: ["市民革命"] }, { id: 1304, question: "市民が政治の主体となる政治体制を何というか", answers: ["民主政治", "民主主義"] }, { id: 1305, question: "人間が生まれもっている自由で平等に生きる権利を何というか", answers: ["自然権"] }, { id: 1306, question: "契約により権利を譲渡し国家が成立するという考え方を何というか", answers: ["社会契約説"] }, { id: 1307, question: "ホッブズは人間の自然状態をどのように表現したか", answers: ["万人の万人に対する闘争"] }, { id: 1308, question: "アメリカ革命に大きな影響を与えたイギリスの思想家は誰か", answers: ["ロック"] }, { id: 1309, question: "『統治二論』で盛り込まれた、政府に対する国民の権利は何か", answers: ["抵抗権", "革命権"] }, { id: 1310, question: "国民の直接民主主義による合意をルソーは何と呼んだか", answers: ["一般意思"] }, { id: 1311, question: "『法の精神』を著したフランスの思想家は誰か", answers: ["モンテスキュー"] }, { id: 1312, question: "立法、行政、司法の権力が互いに抑制し均衡する仕組みを何というか", answers: ["三権分立"] }, { id: 1313, question: "イギリスのジョン王の権力を制限した文書を何というか", answers: ["マグナカルタ"] }, { id: 1314, question: "イギリスの名誉革命を受けて 1689 年に決議された権利宣言は何か", answers: ["権利章典"] }, { id: 1315, question: "政治権力も法の下にあるとする考え方を何というか", answers: ["法の支配"] }, { id: 1316, question: "1776 年、トマス・ジェファーソンによって起草された宣言は何か", answers: ["アメリカ独立宣言"] }, { id: 1317, question: "フランス人権宣言の３つの理念は何か", answers: ["自由、平等、友愛"] }, { id: 1318, question: "社会権を初めて規定したドイツの憲法は何か", answers: ["ワイマール憲法"] }, { id: 1319, question: "人権に関する世界基準となっている国連で採択された宣言は何か", answers: ["世界人権宣言"] }, { id: 1320, question: "大日本帝国憲法では、主権は誰にあったか", answers: ["天皇"] }, { id: 1321, question: "大日本帝国憲法において、国民が天皇から与えられた地位を何というか", answers: ["臣民"] }, { id: 1322, question: "大日本帝国憲法は当時のどの国の憲法を参考にしてつくられたか", answers: ["ドイツ"] }, { id: 1323, question: "大日本帝国憲法が欽定憲法であるのに対し日本国憲法は何憲法といわれるか", answers: ["民定憲法"] }, { id: 1324, question: "憲法に基づいて政治を行う考え方を何というか", answers: ["立憲主義"] }, { id: 1325, question: "連合国が日本に無条件降伏を迫った宣言は何か", answers: ["ポツダム宣言"] }, { id: 1326, question: "戦後に、新憲法作成を主導したアメリカ人は誰か", answers: ["マッカーサー元帥"] }, { id: 1327, question: "憲法の前文に明記されている国民が権力の主体であるとする考え方を何というか", answers: ["国民主権"] }, { id: 1328, question: "日本国憲法で示される天皇の役割は何と表現されているか", answers: ["象徴"] }, { id: 1329, question: "憲法で「侵すことのできない永久の権利」と保障された権利を何というか", answers: ["基本的人権"] }, { id: 1330, question: "憲法で国権の最高機関と規定されているのはどこか", answers: ["国会"] }, { id: 1331, question: "戦争放棄、戦力の不保持を規定しているのは、憲法の何条か", answers: ["9条"] }, { id: 1332, question: "法律が憲法に違反していないかを審査する権利を何というか", answers: ["違憲審査権"] }, { id: 1333, question: "「憲法の番人」といわれる機関は何か", answers: ["最高裁判所"] }, { id: 1334, question: "憲法改正案を発議するために衆参両議院で必要な賛成票はいくつか", answers: ["3分の2以上"] }, { id: 1335, question: "憲法改正は国会発議の後、何にかけられるか", answers: ["国民投票"] }, { id: 1336, question: "改正に厳格な手続きを必要とする憲法のあり方を何というか", answers: ["硬性憲法"] }, { id: 1337, question: "衆参両院に設置されている憲法について審議する会を何というか", answers: ["憲法審査会"] }, { id: 1338, question: "憲法 13 条にある幸福を求める権利を何というか", answers: ["幸福追求権"] }, { id: 1339, question: "人種や信条、性別その他で差別されない権利を主張する理念を何の平等というか", answers: ["法の下の平等"] }, { id: 1340, question: "同性愛者やトランスジェンダーなどの性的少数者を、頭文字から何と総称するか", answers: ["LGBT"] }, { id: 1341, question: "犯罪に科される刑罰は事前に法律で定めておかなければいけないことを何というか", answers: ["罪刑法定主義"] }, { id: 1342, question: "刑罰には法律に基づく手続きが必要である。これを何というか", answers: ["法廷手続きの保障"] }, { id: 1343, question: "不法逮捕や抑留・拘禁などからの自由を総じて何というか", answers: ["身体の自由"] }, { id: 1344, question: "精神の自由のうち言論・出版など自分の考えを発表する権利を何というか", answers: ["表現の自由"] }, { id: 1345, question: "職業選択の自由、財産権などの自由権を何というか", answers: ["経済活動の自由"] }, { id: 1346, question: "国家に対して人間らしい生活を保障するよう求める権利を何という", answers: ["社会権"] }, { id: 1347, question: "健康で文化的な最低限度の生活を営む権利を何というか", answers: ["生存権"] }, { id: 1348, question: "労働三権とは、団結権、団体交渉権ともう一つは何か", answers: ["団体行動権"] }, { id: 1349, question: "国民の義務は「勤労の義務」と「納税の義務」ともう一つは何か", answers: ["教育を受けさせる義務"] }, { id: 1350, question: "国民の権利はときに制限されるが、その根拠となる原理を何というか", answers: ["公共の福祉"] }, { id: 1351, question: "差別是正のため、必要な範囲内で被差別側を優遇する措置を何というか", answers: ["積極的差別是正措置", "アファーマティブ・アクション"] }, { id: 1352, question: "歴史的な経緯を考慮して正義を規定する考え方を何というか", answers: ["通時的正義"] }, { id: 1353, question: "特定の国籍や民族の人に対する差別的な発言や行動を何というか", answers: ["ヘイトスピーチ"] }, { id: 22301, question: "国家を構成する３つの要素とは、領域、主権と何か", answers: ["国民"] }, { id: 22302, question: "国家や国際社会の成立のきっかけになったといわれる条約は何か", answers: ["ウエストファリア条約"] }, { id: 22303, question: "国の領域とは、領海、領空と、何か", answers: ["領土"] }, { id: 22304, question: "漁業や鉱物資源などの権利がある沿岸 200 海里の海域を何というか", answers: ["排他的経済水域"] }, { id: 22305, question: "第二次世界大戦後、植民地地域で起こった民族統一や独立を求める思想は何か", answers: ["ナショナリズム"] }, { id: 22306, question: "国家の枠を超えて環境保護や人道支援を行う民間組織を何というか", answers: ["NGO", "非政府組織"] }, { id: 22307, question: "国際社会の合意や取り決めは慣習国際法ともう一つは何があるか", answers: ["条約"] }, { id: 22308, question: "「国際法の父」といわれるオランダの法学者は誰か", answers: ["グロティウス"] }, { id: 22309, question: "先進国による植民地支配など、対等でない国家間の取り決めを何というか", answers: ["不平等条約"] }, { id: 22310, question: "海洋の安定的な秩序を定めた国際条約は何か", answers: ["国際海洋法条約"] }, { id: 22311, question: "現在日本がロシアと領有権について交渉中の領土を総称して何というか", answers: ["北方領土"] }, { id: 22312, question: "中国が領有権を主張している日本の領土はどこか", answers: ["尖閣諸島"] }, { id: 22313, question: "竹島に警備隊を常駐させている国はどこか", answers: ["韓国"] }, { id: 22314, question: "領土問題など国家間の紛争を提訴できる国連の司法機関はどこか", answers: ["国際司法裁判所"] }, { id: 22315, question: "重大犯罪に対して個人を訴追できる国連の司法機関はどこか", answers: ["国際刑事裁判所"] }, { id: 22316, question: "2002 年の日朝首脳会談で解決を目指した、北朝鮮との問題は何か", answers: ["日本人拉致問題"] }, { id: 22317, question: "日朝首脳会談当時の日本の総理大臣は誰か", answers: ["小泉純一郎"] }, { id: 22318, question: "終戦 50 年を機に初めて日本の植民地支配の責任を認め謝罪した総理大臣は誰か", answers: ["村山富市"] }, { id: 22401, question: "「戦争の放棄」「戦力の不保持」が記されているのは憲法の何条か", answers: ["9条"] }, { id: 22402, question: "自国を守るために武力を用いる権利を何というか", answers: ["専守防衛", "個別自衛権"] }, { id: 22403, question: "文民が軍隊の最高指揮権を持つことを何というか", answers: ["シビリアンコントロール", "文民統制"] }, { id: 22404, question: "米軍立川飛行場の拡張に反対し駐留米軍の合憲性を問うた事件は何か", answers: ["砂川事件"] }, { id: 22405, question: "自衛隊のミサイル・ナイキ基地建設に反対して周辺住民が提訴した訴訟は何か", answers: ["長沼ナイキ訴訟"] }, { id: 22406, question: "自衛隊の合憲性を判断する際、司法判断保留の根拠とされる考え方は何か", answers: ["統治行為論"] }, { id: 22407, question: "同盟国が攻撃され日本にも危機的な影響がある場合、同盟国とともに武力行使できるという考え方 を何というか", answers: ["集団的自衛権"] }, { id: 22408, question: "日本とアメリカが共同で日本と周辺地域を防衛することを定めた条約は何か", answers: ["日米安全保障条約"] }, { id: 22409, question: "米軍の日本駐留経費の一部を日本が負担することを通称何というか", answers: ["思いやり予算"] }, { id: 22410, question: "犯罪を犯した米軍人に対する特権的な法的地位を定めた協定は何か", answers: ["日米地位協定"] }, { id: 22411, question: "自衛隊の海外派遣が議論されるきっかけとなった 1991 年に起こった戦争は何か", answers: ["湾岸戦争"] }, { id: 22412, question: "国連の平和維持活動への日本の参加を規定した法律は何か", answers: ["PKO協力法", "国連平和維持活動協力法"] }, { id: 22413, question: "2015 年に改正され自衛隊による他国軍の後方支援を日本周辺以外の地域でも行うことを可能にした法律は何か", answers: ["安全保障関連法", "平和安全法制"] }, { id: 22414, question: "2001 年にイスラム過激派組織がアメリカで起こした大規模テロを何というか", answers: ["アメリカ同時多発テロ"] }, { id: 22415, question: "アメリカの対テロ戦争時に自衛隊を派遣するために期限付きで制定された法律は何か", answers: ["テロ対策特別措置法"] }, { id: 22416, question: "イラク戦争時に制定された、期限付きで自衛隊派遣を可能にする法律は何か", answers: ["イラク復興支援特別措置法"] }, { id: 22417, question: "安全保障上の有事に対処するため、2013 年に設置された会議は何か", answers: ["国家安全保障会議"] }, { id: 22418, question: "テロの背景にあると考えられる、自民族の優越性を誇示する思想を何というか", answers: ["エスノセントリズム", "自民族中心主義"] }, { id: 22419, question: "テロ組織へ加担しているとして 2003 年にアメリカがイギリスらとともに始めた戦争は何か", answers: ["イラク戦争"] }, { id: 22420, question: "2011 年、チュニジア、エジプト、リビアなどで起こった民主化運動を何というか", answers: ["アラブの春"] }, { id: 22421, question: "イスラム原理主義を掲げ中東地域で一時大きな勢力を誇った過激派組織を何というか", answers: ["ISIL", "イスラム国"] }, { id: 22422, question: "人種、宗教などを理由に迫害されるおそれがあり国から逃れた人々を何というか", answers: ["難民"] }, { id: 22423, question: "加盟国に難民を保護する義務を定めた条約は何か", answers: ["難民の地位に関する条約", "難民条約"] }, { id: 22424, question: "難民救済の活動を行う国連機関は何か", answers: ["国連難民高等弁務官事務所", "UNHCR"] }, { id: 22425, question: "アフリカで氏族間の抗争から長期にわたって無政府状態が続いている紛争は何か", answers: ["ソマリア内戦"] }, { id: 22426, question: "「核兵器をもたず・つくらず・もちこませず」を表明した原則を何というか", answers: ["非核三原則"] }, { id: 22427, question: "世界で唯一、戦争被爆国である国はどこか", answers: ["日本"] }, { id: 22428, question: "原子力の平和利用と軍事転用の禁止を目的に設置された国連機関は何か", answers: ["国際原子力機関", "IAEA"] }, { id: 22429, question: "2017 年に国連で採択された核兵器の全面禁止と根絶を目指す条約は何か", answers: ["核兵器禁止条約"] }, { id: 22501, question: "第二次世界大戦後の 1951 年に締結した、日本が主権回復した条約は何か", answers: ["サンフランシスコ平和条約"] }, { id: 22502, question: "1956 年にソ連と国交を回復した宣言は何か", answers: ["日ソ共同宣言"] }, { id: 22503, question: "第一次世界大戦後の 1920 年に発足した国家連合組織は何か", answers: ["国際連盟"] }, { id: 22504, question: "集団安全保障を強化するために設置された国連の機関は何か", answers: ["安全保障理事会"] }, { id: 22505, question: "常任理事国はアメリカ、中国、イギリス、フランスとどこか", answers: ["ロシア"] }, { id: 22506, question: "国連総会が軍事措置の勧告を行う決議を何というか", answers: ["平和のための結集"] }, { id: 22507, question: "1965 年に日本と韓国で締結された条約は何か", answers: ["日韓基本条約"] }, { id: 22508, question: "中国との国交正常化後、1978 年に日中で締結した条約は何か", answers: ["日中平和友好条約"] }, { id: 22509, question: "1992 年、日本が初の PKO として自衛隊を派遣した国はどこか", answers: ["カンボジア"] }, { id: 22510, question: "日本が 1993 年から国連と共同開催している国際会議は何か", answers: ["アフリカ開発会議", "TICAD"] }, { id: 22511, question: "先進国が発展途上国に対して開発資金や技術を援助することを何というか", answers: ["政府開発援助", "ODA"] }, { id: 22512, question: "募金や寄付などを資金に環境保護や人道支援に取り組む民間組織を何というか", answers: ["NGO", "非政府組織"] }, { id: 22513, question: "民間よる非政府組織で比較的規模の小さなものを何というか", answers: ["NPO"] }, { id: 22514, question: "アフガニスタンの医療活動や水資源の開発に奉仕した日本人医師は誰か", answers: ["中村哲"] }, { id: 22515, question: "暴力や貧困などさまざまな脅威から人間一人ひとりを守る考え方を何というか", answers: ["人間の安全保障"] }, { id: 22516, question: "人間の潜在能力の向上を主張し国連の活動に影響を与えた経済学者は誰か", answers: ["セン"] }, { id: 22517, question: "SDGs は日本語で何と訳されているか", answers: ["持続可能な開発目標"] }, { id: 22518, question: "貿易についての交渉や取り決めを行う国連の機関は何か", answers: ["WTO", "世界貿易機関"] }
            ],
            kobun: [
                { question: "たいへん。とても。", answer: "いと", kanji: "" },
                { question: "いっそう。ますます。さらに。", answer: "いとど", kanji: "" },
                { question: "《疑問》どうして～か", answer: "など", kanji: "" },
                { question: "《反語》どうして～か、いや～でない", answer: "など", kanji: "" },
                { question: "いつの間にか。早く。", answer: "いつしか", kanji: "何時しか" },
                { question: "互いに", answer: "かたみに", kanji: "互に" },
                { question: "なるほど。本当に", answer: "げに", kanji: "実に" },
                { question: "なるほど。", answer: "むべ", kanji: "" },
                { question: "一日中。日中ずっと。", answer: "ひねもす", kanji: "終日" },
                { question: "一晩中。夜通し。", answer: "よもすがら", kanji: "夜もすがら" },
                { question: "早く。すぐに。急いで。", answer: "とく", kanji: "疾く" },
                { question: "すでに。とっくに。早くも。", answer: "とく", kanji: "疾く" },
                { question: "～ないでください。", answer: "な～そ", kanji: "" },
                { question: "さっきの。先述の。例の。", answer: "ありつる", kanji: "" },
                { question: "以前の。昔の。生前の。", answer: "ありし", kanji: "" },
                { question: "別の。違った。意外な。望ましくない。", answer: "あらぬ", kanji: "" },
                { question: "どうにでもなれ。ええ、ままよ。", answer: "さはれ", kanji: "" },
                { question: "しっ、静かに。ああ、やかましい。", answer: "あなかま", kanji: "" },
                { question: "～しきれない。～するとすぐに。", answer: "あへず", kanji: "" },
                { question: "そうなるはずの。ふさわしい。立派な。", answer: "さるべき", kanji: "" },
                { question: "さあ、いらっしゃい。", answer: "いざたまへ", kanji: "いざ給へ" },
                { question: "思った通りだ。案の定。", answer: "さればこそ", kanji: "" },
                { question: "名前として持っている。有名だ。", answer: "なにしおふ", kanji: "名にし負ふ" },
                { question: "いつものように。", answer: "れいの", kanji: "例の" },
                { question: "並々ではない。", answer: "おろかならず", kanji: "疎かならず" },
                { question: "言うまでもない。", answer: "いふもおろかなり", kanji: "言ふも疎かなり" },
                { question: "物足りない。いつまでも飽きることがない。", answer: "あかず", kanji: "飽かず" },
                { question: "結婚する。皆で～する", answer: "あふ", kanji: "合う・会う・逢う" },
                { question: "(男が女を)妻とする。", answer: "みる", kanji: "見る" },
                { question: "男女が関係を持つ。親しくする。説得して味方につける。", answer: "かたらふ", kanji: "語らふ" },
                { question: "(付き合っている／結婚している相手に対して)あなた", answer: "ひと", kanji: "人" },
                { question: "世間の人。立派な人。", answer: "ひと", kanji: "人" },
                { question: "目立たない格好にする。出家姿にする。", answer: "やつす", kanji: "窶す" },
                { question: "通う。似通う。", answer: "かよふ", kanji: "通ふ" },
                { question: "愛する。思い悩む。", answer: "おもふ", kanji: "思ふ" },
                { question: "途絶えがちだ。", answer: "かれがれなり", kanji: "離れ離れなり" },
                { question: "移動する。色あせる。心変わりする。", answer: "うつろふ", kanji: "移ろふ" },
                { question: "夫婦の仲。男女の間柄。", answer: "よ", kanji: "世" },
                { question: "夫婦の仲。男女の間柄。", answer: "よのなか", kanji: "世の中" }
            ]
        };

        // --- App State ---
        let allData = {};
        let quizItems = [];
        let currentQuizMode = null;
        let currentQuestionIndex = 0;
        let score = 0;
        let QUIZ_LENGTH = 10;
        let masteryStatus = {};
        let masteredBeforeQuiz = 0;
        let onConfirmAction = null;

        // --- DOM Elements ---
        const modeSelectionScreen = document.getElementById('mode-selection-screen');
        const englishStartScreen = document.getElementById('english-start-screen');
        const publicStartScreen = document.getElementById('public-start-screen');
        const kobunStartScreen = document.getElementById('kobun-start-screen');
        const quizScreen = document.getElementById('quiz-screen');
        const resultScreen = document.getElementById('result-screen');
        const selectEnglishBtn = document.getElementById('select-english-btn');
        const selectPublicBtn = document.getElementById('select-public-btn');
        const selectKobunBtn = document.getElementById('select-kobun-btn');
        const backToModeSelectionBtns = document.querySelectorAll('.back-to-mode-selection');
        const quizTitle = document.getElementById('quiz-title');
        const questionCounter = document.getElementById('question-counter');
        const questionText = document.getElementById('question-text');
        const userInput = document.getElementById('user-input');
        const checkBtn = document.getElementById('check-btn');
        const nextBtn = document.getElementById('next-btn');
        const feedback = document.getElementById('feedback');
        const scoreText = document.getElementById('score-text');
        const scoreMessage = document.getElementById('score-message');
        const masteryCount = document.getElementById('mastery-count');
        const resultsList = document.getElementById('results-list');
        const downloadCsvBtn = document.getElementById('download-csv-btn');
        const downloadPdfBtn = document.getElementById('download-pdf-btn');
        const playAgainBtn = document.getElementById('play-again-btn');
        const confirmModal = document.getElementById('confirm-modal');
        const confirmMessage = document.getElementById('confirm-message');
        const confirmOkBtn = document.getElementById('confirm-ok-btn');
        const confirmCancelBtn = document.getElementById('confirm-cancel-btn');
        const alertModal = document.getElementById('alert-modal');
        const alertMessage = document.getElementById('alert-message');
        const alertOkBtn = document.getElementById('alert-ok-btn');
        const themeToggle = document.getElementById('checkbox');

        // --- LocalStorage Functions ---
        const getLocalStorage = (key) => {
            try {
                const data = localStorage.getItem(key);
                return data ? JSON.parse(data) : {};
            } catch (e) {
                console.error("ローカルストレージの読み込みに失敗:", e);
                return {};
            }
        };
        const setLocalStorage = (key, value) => {
            try {
                localStorage.setItem(key, JSON.stringify(value));
            } catch (e) {
                console.error("ローカルストレージへの保存に失敗:", e);
            }
        };

        // --- Helper Functions ---
        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }

        function normalizeAnswer(str) {
            if (typeof str !== 'string') return '';
            return str.trim().toLowerCase()
                .replace(/[Ａ-Ｚａ-ｚ０-９]/g, s => String.fromCharCode(s.charCodeAt(0) - 0xFEE0))
                .replace(/　/g, ' ');
        }

        // --- Modal ---
        function showAlertModal(message) {
            alertMessage.textContent = message;
            alertModal.classList.remove('hidden');
        }
        function hideAlertModal() { alertModal.classList.add('hidden'); }
        function showConfirmModal(message, onConfirm) {
            confirmMessage.textContent = message;
            onConfirmAction = onConfirm;
            confirmModal.classList.remove('hidden');
        }
        function hideConfirmModal() {
            confirmModal.classList.add('hidden');
            onConfirmAction = null;
        }

        // --- Screen Management ---
        function showScreen(screen) {
            [modeSelectionScreen, englishStartScreen, publicStartScreen, kobunStartScreen, quizScreen, resultScreen].forEach(s => s.classList.add('hidden'));
            screen.classList.remove('hidden');
        }

        // --- Mastery and Stats Logic ---
        function createStartScreen(mode, title) {
            const screen = document.getElementById(`${mode}-start-screen`);
            screen.innerHTML = `
                <h1 class="text-3xl font-bold text-center mb-2">${title}</h1>
                <p class="text-center text-secondary mb-6">学習状況を確認してクイズを始めよう！</p>
                <div id="${mode}-mastery-stats" class="grid grid-cols-2 sm:grid-cols-4 gap-4 text-center mb-8"></div>
                <button id="start-${mode}-btn" class="btn btn-primary w-full">クイズを開始</button>
                <button id="reset-${mode}-btn" class="btn btn-secondary w-full mt-4 !bg-red-800 hover:!bg-red-700">学習履歴をリセット</button>
                <button class="back-to-mode-selection btn btn-secondary w-full mt-4">モード選択に戻る</button>
                <div id="reset-${mode}-feedback" class="text-center text-green-400 mt-4 text-sm h-5"></div>
            `;
        }

        function updateMasteryStats(mode) {
            const data = allData[mode];
            const statusData = masteryStatus[mode];
            const container = document.getElementById(`${mode}-mastery-stats`);
            
            container.innerHTML = `
                <div><p class="text-2xl font-bold text-sky-400" id="${mode}-unattempted-count">0</p><p class="text-xs text-secondary">未実施</p></div>
                <div><p class="text-2xl font-bold text-red-400" id="${mode}-unlearned-count">0</p><p class="text-xs text-secondary">未習得</p></div>
                <div><p class="text-2xl font-bold text-amber-400" id="${mode}-checking-count">0</p><p class="text-xs text-secondary">点検中</p></div>
                <div><p class="text-2xl font-bold text-green-400" id="${mode}-mastered-count">0</p><p class="text-xs text-secondary">習得</p></div>
            `;
            const counts = { '未実施': 0, '未習得': 0, '点検中': 0, '習得': 0 };
            data.forEach(item => {
                const status = statusData[item.id] || '未実施';
                counts[status]++;
            });
            document.getElementById(`${mode}-unattempted-count`).textContent = counts['未実施'];
            document.getElementById(`${mode}-unlearned-count`).textContent = counts['未習得'];
            document.getElementById(`${mode}-checking-count`).textContent = counts['点検中'];
            document.getElementById(`${mode}-mastered-count`).textContent = counts['習得'];
        }

        function resetHistory(mode) {
            const modeTitle = mode === 'english' ? '英単語' : (mode === 'public' ? '公共' : '古文単語');
            const message = `${modeTitle}の学習履歴をすべてリセットしますか？`;
            showConfirmModal(message, () => {
                masteryStatus[mode] = {};
                setLocalStorage(`${mode}MasteryStatus`, {});
                updateMasteryStats(mode);
                const feedbackEl = document.getElementById(`reset-${mode}-feedback`);
                feedbackEl.textContent = '履歴をリセットしました。';
                setTimeout(() => { feedbackEl.textContent = ''; }, 2000);
                hideConfirmModal();
            });
        }
        
        function downloadUnlearnedCSV() {
            const data = allData[currentQuizMode];
            const statusData = masteryStatus[currentQuizMode];

            const unlearnedItems = data.filter(item => statusData[item.id] === '未習得');
            if (unlearnedItems.length === 0) { showAlertModal("未習得の項目はありません。"); return; }
            
            const isEnglish = currentQuizMode === 'english';
            const isKobun = currentQuizMode === 'kobun';
            let headers, body;

            if (isEnglish) {
                headers = "日本語,English\r\n";
                body = unlearnedItems.map(item => `"${item.question}","${item.answer}"`).join('\r\n');
            } else if (isKobun) {
                headers = "問題,答え,漢字\r\n";
                body = unlearnedItems.map(item => `"${item.question}","${item.answer}","${item.kanji || ''}"`).join('\r\n');
            } else { // public
                headers = "問題,解答\r\n";
                body = unlearnedItems.map(item => `"${item.question}","${item.answers.join(' / ')}"`).join('\r\n');
            }
            let csvContent = "data:text/csv;charset=utf-8,\uFEFF" + headers + body;

            const link = document.createElement("a");
            link.setAttribute("href", encodeURI(csvContent));
            link.setAttribute("download", `unlearned_${currentQuizMode}.csv`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        async function downloadUnlearnedPDF() {
            const data = allData[currentQuizMode];
            const statusData = masteryStatus[currentQuizMode];
            
            const unlearnedItems = data.filter(item => statusData[item.id] === '未習得');
            if (unlearnedItems.length === 0) { showAlertModal("未習得の項目はありません。"); return; }

            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            try {
                // This is a simplified approach. For full Japanese support in jsPDF, a custom font is needed.
                // This part requires hosting the font file or using a library that embeds it.
                // For simplicity, we'll proceed, but characters might not render correctly without the font.
                doc.setFont("helvetica"); // Default font, may not support Japanese. A proper implementation would require embedding a font.
                showAlertModal("PDFを生成中です... 日本語フォントの読み込みに時間がかかる場合があります。");
                
                const isEnglish = currentQuizMode === 'english';
                const isKobun = currentQuizMode === 'kobun';
                let head, body;

                 if (isEnglish) {
                    head = [["日本語", "English"]];
                    body = unlearnedItems.map(item => [item.question, item.answer]);
                } else if (isKobun) {
                    head = [["問題", "答え", "漢字"]];
                    body = unlearnedItems.map(item => [item.question, item.answer, item.kanji || '']);
                } else { // public
                    head = [["問題", "解答"]];
                    body = unlearnedItems.map(item => [item.question, item.answers.join(' / ')]);
                }

                // A simple text-based fallback if autoTable fails with custom fonts
                let y = 15;
                doc.text(`${currentQuizMode === 'english' ? '英単語' : (currentQuizMode === 'public' ? '公共' : '古文単語')} 未習得リスト`, 14, y);
                y += 10;
                unlearnedItems.forEach(item => {
                    if (y > 280) { // New page
                        doc.addPage();
                        y = 15;
                    }
                    const question = isEnglish || isKobun ? item.question : item.question;
                    const answer = isEnglish ? item.answer : (isKobun ? `${item.answer} [${item.kanji || ''}]` : item.answers.join(' / '));
                    doc.text(`${question}: ${answer}`, 14, y);
                    y += 7;
                });

                doc.save(`unlearned_${currentQuizMode}.pdf`);
            } catch (e) {
                console.error("PDF生成エラー:", e);
                showAlertModal("PDFの生成に失敗しました。");
            }
        }

        // --- Core Quiz Logic ---
        function startQuiz(mode) {
            currentQuizMode = mode;
            score = 0;
            currentQuestionIndex = 0;
            QUIZ_LENGTH = 10;
            
            const data = allData[mode];
            const statusData = masteryStatus[mode];
            masteredBeforeQuiz = Object.values(statusData).filter(s => s === '習得').length;

            const unattempted = data.filter(item => !statusData[item.id] || statusData[item.id] === '未実施');
            const unlearned = data.filter(item => statusData[item.id] === '未習得');
            const checking = data.filter(item => statusData[item.id] === '点検中');
            const mastered = data.filter(item => statusData[item.id] === '習得');

            let pool = [...shuffleArray(unattempted), ...shuffleArray(unlearned)];
            if (pool.length < QUIZ_LENGTH) pool.push(...shuffleArray(checking));
            if (pool.length < QUIZ_LENGTH) pool.push(...shuffleArray(mastered));
            
            quizItems = pool.slice(0, Math.min(QUIZ_LENGTH, data.length));
            
            QUIZ_LENGTH = quizItems.length;
            if (QUIZ_LENGTH === 0) {
                 showAlertModal("出題できる問題がありません！");
                 return;
            }

            showScreen(quizScreen);
            displayQuestion();
        }

        function displayQuestion() {
            if (currentQuestionIndex >= quizItems.length) {
                showResults();
                return;
            }
            const currentItem = quizItems[currentQuestionIndex];
            const modeTitle = currentQuizMode === 'english' ? '英単語クイズ' : (currentQuizMode === 'public' ? '公共テスト' : '古文単語クイズ');
            quizTitle.textContent = modeTitle;
            questionCounter.textContent = `問題 ${currentQuestionIndex + 1} / ${QUIZ_LENGTH}`;
            questionText.textContent = currentItem.question;
            
            userInput.value = '';
            userInput.disabled = false;
            userInput.focus();
            feedback.innerHTML = '';
            checkBtn.classList.remove('hidden');
            nextBtn.classList.add('hidden');
        }

        function checkAnswer() {
            const userAnswer = userInput.value.trim();
            if (userAnswer.length === 0) {
                 // Treat empty input as incorrect answer and move on
            }
            const currentItem = quizItems[currentQuestionIndex];
            userInput.disabled = true;

            let isCorrect = false;
            let correctAnswersText = '';
            const statusData = masteryStatus[currentQuizMode];
            const storageKey = `${currentQuizMode}MasteryStatus`;

            if (currentQuizMode === 'english' || currentQuizMode === 'kobun') {
                correctAnswersText = currentItem.answer;
                isCorrect = normalizeAnswer(userAnswer) === normalizeAnswer(correctAnswersText);
            } else { // public
                correctAnswersText = currentItem.answers.join(' / ');
                const normalizedUserAnswer = normalizeAnswer(userAnswer);
                isCorrect = currentItem.answers.some(ans => normalizeAnswer(ans) === normalizedUserAnswer);
            }
            
            const itemId = currentItem.id;
            const currentStatus = statusData[itemId] || '未実施';
            let feedbackHtml = '';

            if (isCorrect && userAnswer.length > 0) {
                score++;
                feedbackHtml = `<p class="text-green-400 font-bold text-lg">正解！</p>`;
                if (currentStatus === '未実施' || currentStatus === '未習得') statusData[itemId] = '点検中';
                else if (currentStatus === '点検中') statusData[itemId] = '習得';
            } else {
                feedbackHtml = `<p class="text-red-400 font-bold text-lg">不正解...</p><p class="text-secondary">正解は: <span class="font-bold text-primary">${correctAnswersText}</span></p>`;
                statusData[itemId] = '未習得';
            }
            
            if (currentQuizMode === 'kobun' && currentItem.kanji) {
                feedbackHtml += `<p class="text-sky-400 mt-1">【漢字】 ${currentItem.kanji}</p>`;
            }
            feedback.innerHTML = feedbackHtml;

            setLocalStorage(storageKey, statusData);
            
            checkBtn.classList.add('hidden');
            nextBtn.classList.remove('hidden');
            nextBtn.focus();
        }
        
        function showResults() {
            showScreen(resultScreen);
            scoreText.textContent = `${score} / ${QUIZ_LENGTH}`;
            let message = '';
            if (score === QUIZ_LENGTH) message = '素晴らしい！全問正解です！';
            else if (score >= QUIZ_LENGTH * 0.7) message = '良い調子ですね！';
            else if (score >= QUIZ_LENGTH * 0.4) message = 'もう少し！頑張りましょう。';
            else message = '次はもっと頑張ろう！';
            scoreMessage.textContent = message;

            resultsList.innerHTML = '';
            quizItems.forEach(item => {
                const listItem = document.createElement('div');
                listItem.className = 'results-list-item';
                const question = item.question;
                const answer = currentQuizMode === 'public' ? item.answers.join(' / ') : item.answer;
                listItem.innerHTML = `
                    <span class="text-secondary w-2/3 truncate">${question}</span>
                    <span class="font-bold w-1/3 text-right">${answer}</span>`;
                resultsList.appendChild(listItem);
            });
            
            const data = allData[currentQuizMode];
            const statusData = masteryStatus[currentQuizMode];
            
            const learnedCount = Object.values(statusData).filter(s => s === '習得').length;
            const change = learnedCount - masteredBeforeQuiz;
            const changeString = change > 0 ? `+${change}` : (change < 0 ? `${change}` : `${change}`);
            masteryCount.innerHTML = `現在の習得数: <span class="font-bold text-xl">${learnedCount}</span> / ${data.length} <span class="text-sm">(前回比: ${changeString})</span>`;
        }

        // --- Initialization and Event Listeners ---
        function initializeAllData() {
            // Process English Data
            const wordMap = new Map();
            DATA_SETS.english.forEach(word => {
                const key = word.answer.toLowerCase(); // 'english' renamed to 'answer'
                if (wordMap.has(key)) {
                    const existing = wordMap.get(key);
                    existing.question = `${existing.question}；${word.question}`; // 'japanese' renamed to 'question'
                } else { wordMap.set(key, { ...word }); }
            });
            allData.english = Array.from(wordMap.values()).map((word, index) => ({ ...word, id: index }));

            // Process Public Affairs Data
            allData.public = DATA_SETS.public.map(q => ({...q, question: q.question, answers: q.answers}));

            // Process Kobun Data
            const kobunMap = new Map();
            DATA_SETS.kobun.forEach(word => {
                const key = `${word.answer}-${word.question}`;
                if (!kobunMap.has(key)) {
                    kobunMap.set(key, { ...word });
                }
            });
            allData.kobun = Array.from(kobunMap.values()).map((word, index) => ({ ...word, id: index }));


            // Load mastery from localStorage
            ['english', 'public', 'kobun'].forEach(mode => {
                const data = allData[mode];
                const savedStatus = getLocalStorage(`${mode}MasteryStatus`) || {};
                const validIds = new Set(data.map(w => w.id));
                Object.keys(savedStatus).forEach(id => {
                    if (!validIds.has(parseInt(id, 10))) delete savedStatus[id];
                });
                masteryStatus[mode] = savedStatus;
                setLocalStorage(`${mode}MasteryStatus`, savedStatus);
            });
        }
        
        document.addEventListener('DOMContentLoaded', () => {
            initializeAllData();

            // Create Start Screens dynamically
            createStartScreen('english', '英単語クイズ');
            createStartScreen('public', '公共テスト');
            createStartScreen('kobun', '古文単語クイズ');

            // Add event listeners for dynamic buttons
            document.body.addEventListener('click', (e) => {
                if (e.target.matches('#start-english-btn')) startQuiz('english');
                if (e.target.matches('#start-public-btn')) startQuiz('public');
                if (e.target.matches('#start-kobun-btn')) startQuiz('kobun');
                if (e.target.matches('#reset-english-btn')) resetHistory('english');
                if (e.target.matches('#reset-public-btn')) resetHistory('public');
                if (e.target.matches('#reset-kobun-btn')) resetHistory('kobun');
                if (e.target.matches('.back-to-mode-selection')) showScreen(modeSelectionScreen);
            });
            
            // Set initial theme
            const currentTheme = localStorage.getItem('theme');
            if (currentTheme === 'dark') {
                document.documentElement.classList.add('dark');
                themeToggle.checked = true;
            } else {
                document.documentElement.classList.remove('dark');
                themeToggle.checked = false;
            }

            showScreen(modeSelectionScreen);
        });

        // Mode Selection Listeners
        selectEnglishBtn.addEventListener('click', () => { updateMasteryStats('english'); showScreen(englishStartScreen); });
        selectPublicBtn.addEventListener('click', () => { updateMasteryStats('public'); showScreen(publicStartScreen); });
        selectKobunBtn.addEventListener('click', () => { updateMasteryStats('kobun'); showScreen(kobunStartScreen); });

        // Quiz Flow Listeners
        checkBtn.addEventListener('click', checkAnswer);
        nextBtn.addEventListener('click', () => { currentQuestionIndex++; displayQuestion(); });
        playAgainBtn.addEventListener('click', () => {
            const startScreenId = `${currentQuizMode}-start-screen`;
            updateMasteryStats(currentQuizMode);
            showScreen(document.getElementById(startScreenId));
        });
        userInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
                e.preventDefault();
                if (!checkBtn.classList.contains('hidden')) checkBtn.click();
                else if (!nextBtn.classList.contains('hidden')) nextBtn.click();
            }
        });

        // Download Listeners
        downloadCsvBtn.addEventListener('click', downloadUnlearnedCSV);
        downloadPdfBtn.addEventListener('click', downloadUnlearnedPDF);
        
        // Modal Listeners
        confirmOkBtn.addEventListener('click', () => { if (onConfirmAction) onConfirmAction(); });
        confirmCancelBtn.addEventListener('click', hideConfirmModal);
        alertOkBtn.addEventListener('click', hideAlertModal);
        
        // Theme Toggle Listener
        themeToggle.addEventListener('change', function() {
            if(this.checked) {
                document.documentElement.classList.add('dark');
                localStorage.setItem('theme', 'dark');
            } else {
                document.documentElement.classList.remove('dark');
                localStorage.setItem('theme', 'light');
            }
        });
        
    </script>
</body>
</html>

